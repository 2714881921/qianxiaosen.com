<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæç¤ºè¯æ™ºèƒ½ç”Ÿæˆå™¨ - æé€Ÿç‰ˆ</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Tailwindé…ç½® -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    keyframes: {
                        spin: {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        }
                    },
                    animation: {
                        spin: 'spin 1s linear infinite',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .input-focus { @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none; }
            .btn-hover { @apply hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200; }
            .card-hover { @apply hover:shadow-md hover:border-primary/30 transition-all duration-200; }
        }
        /* å…¨å±€æ ·å¼ */
        html { transition: background-color 0.3s ease, color 0.3s ease; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-400 rounded-full dark:bg-slate-600; }
        ::-webkit-scrollbar-track { @apply bg-slate-100 dark:bg-slate-800; }
        /* åŠ è½½å¼¹çª—ï¼šä»…å¼‚æ­¥æ—¶æ˜¾ç¤º */
        .loading-overlay {
            @apply fixed inset-0 bg-black/50 dark:bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm hidden;
        }
        /* è¯„åˆ†æ ·å¼ */
        .star-active { @apply text-warning; }
        .star-inactive { @apply text-slate-300 dark:text-slate-700; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen flex flex-col transition-colors duration-300">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white dark:bg-slate-800 shadow-sm py-4 px-6 dark:border-b dark:border-slate-700">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold flex items-center gap-2">
                <i class="fas fa-robot text-primary"></i>
                AIæç¤ºè¯æé€Ÿç”Ÿæˆå™¨
            </h1>
            <div class="flex items-center gap-4">
                <!-- æ¨¡å‹æ¨¡å¼åˆ‡æ¢ -->
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-secondary dark:text-slate-400 hidden sm:inline">æ¨¡å‹ï¼š</span>
                    <select id="model-mode" class="bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-1.5 text-sm input-focus">
                        <option value="local">æœ¬åœ°æé€Ÿä¼˜åŒ–ï¼ˆæ¯«ç§’çº§ï¼‰</option>
                        <option value="api">çœŸå®AIæ¨¡å‹ï¼ˆéœ€APIï¼‰</option>
                    </select>
                </div>
                <!-- æ·±è‰²æ¨¡å¼åˆ‡æ¢ -->
                <button id="theme-toggle" class="bg-primary/10 dark:bg-primary/20 p-2 rounded-full btn-hover" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼">
                    <i class="fas fa-sun text-yellow-500 dark:hidden"></i>
                    <i class="fas fa-moon text-slate-200 hidden dark:inline"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-grow py-8 px-6">
        <div class="max-w-5xl mx-auto bg-white dark:bg-slate-800 rounded-xl shadow-md dark:shadow-slate-700/20 p-6 md:p-8 border dark:border-slate-700">
            <!-- 1. AIæ¨¡å‹é…ç½®åŒº -->
            <div class="mb-6 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                <h3 class="text-slate-700 dark:text-slate-200 font-medium mb-3 flex items-center gap-2">
                    <i class="fas fa-cogs text-primary"></i> æ¨¡å‹é…ç½®
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- AIæ¨¡å‹ç±»å‹ -->
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">AIæ¨¡å‹ç±»å‹</label>
                        <select id="ai-model-type" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg input-focus bg-white dark:bg-slate-600 dark:text-slate-100">
                            <option value="general">é€šç”¨å¤§æ¨¡å‹</option>
                            <option value="painting">ç»˜ç”»æ¨¡å‹ï¼ˆMJ/SDï¼‰</option>
                            <option value="writing">æ–‡æ¡ˆæ¨¡å‹ï¼ˆå°çº¢ä¹¦/å…¬ä¼—å·ï¼‰</option>
                            <option value="coding">ç¼–ç¨‹æ¨¡å‹ï¼ˆCopilotï¼‰</option>
                        </select>
                    </div>
                    <!-- æ ¸å¿ƒå‚æ•° -->
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">æ ¸å¿ƒå‚æ•°</label>
                        <div class="grid grid-cols-2 gap-2">
                            <select id="word-count" class="p-3 border border-slate-300 dark:border-slate-600 rounded-lg input-focus bg-white dark:bg-slate-600 dark:text-slate-100">
                                <option value="unlimited">ä¸é™å­—æ•°</option>
                                <option value="50">50å­—å†…</option>
                                <option value="100">100å­—å†…</option>
                                <option value="200">200å­—å†…</option>
                                <option value="300">300å­—å†…</option>
                            </select>
                            <input type="text" id="prompt-style" placeholder="é£æ ¼ï¼šèµ›åšæœ‹å…‹/æ²»æ„ˆ..." class="p-3 border border-slate-300 dark:border-slate-600 rounded-lg input-focus bg-white dark:bg-slate-600 dark:text-slate-100">
                        </div>
                    </div>
                </div>
                <!-- APIé…ç½®åŒºï¼ˆä»…APIæ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                <div id="api-config" class="mt-4 p-3 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800/50 hidden">
                    <label class="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">APIé…ç½®ï¼ˆé€šä¹‰åƒé—®ç¤ºä¾‹ï¼‰</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="text" id="api-key" placeholder="è¾“å…¥ä½ çš„API Key" class="p-2 border rounded-lg input-focus text-sm">
                        <input type="text" id="api-url" placeholder="APIåœ°å€" value="https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation" class="p-2 border rounded-lg input-focus text-sm">
                    </div>
                </div>
            </div>

            <!-- 2. è¾“å…¥åŒºåŸŸ -->
            <div class="mb-6">
                <label for="user-need" class="block text-slate-700 dark:text-slate-200 font-medium mb-2">
                    ä½ çš„æ ¸å¿ƒéœ€æ±‚ <span class="text-danger dark:text-red-400">*</span>
                </label>
                <textarea 
                    id="user-need" 
                    class="w-full h-32 md:h-40 p-4 border border-slate-300 dark:border-slate-600 rounded-lg input-focus resize-y bg-white dark:bg-slate-600 dark:text-slate-100 dark:placeholder-slate-400"
                    placeholder="ä¾‹ï¼šç”Ÿæˆèµ›åšæœ‹å…‹åŸå¸‚å¤œæ™¯ï¼Œé›¨å¤©éœ“è™¹ã€æœªæ¥å»ºç­‘ï¼›æˆ–å†™é©¬å¹´æ˜¥èŠ‚æœ‹å‹åœˆæ–‡æ¡ˆ..."
                ></textarea>
                <p class="text-xs text-secondary dark:text-slate-400 mt-2">ğŸ’¡ éœ€æ±‚è¶Šå…·ä½“ï¼Œæç¤ºè¯è¶Šç²¾å‡†ï¼æœ¬åœ°æ¨¡å‹æ¯«ç§’çº§å“åº”ï¼Œæ— éœ€ç­‰å¾…</p>
            </div>

            <!-- 3. æ“ä½œæŒ‰é’®åŒº -->
            <div class="flex gap-4 mb-8 flex-wrap">
                <button id="generate-btn" class="bg-primary text-white px-6 py-3 rounded-lg font-medium btn-hover flex items-center gap-2">
                    <i class="fas fa-magic"></i> ä¸€é”®ç”Ÿæˆæç¤ºè¯
                </button>
                <button id="clear-btn" class="bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 px-6 py-3 rounded-lg font-medium btn-hover flex items-center gap-2">
                    <i class="fas fa-trash"></i> æ¸…ç©ºå†…å®¹
                </button>
            </div>

            <!-- 4. ç»“æœå±•ç¤ºåŒº -->
            <div class="border-t border-slate-200 dark:border-slate-700 pt-8 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-slate-700 dark:text-slate-200 font-medium flex items-center gap-2 text-lg">
                        <i class="fas fa-check-circle text-success"></i> ä¼˜åŒ–ç»“æœ
                    </h3>
                    <span id="result-score" class="hidden items-center gap-1 text-lg font-bold">
                        <span>è¯„åˆ†ï¼š</span>
                        <span id="score-value" class="text-warning">0</span>
                        <span>/100</span>
                    </span>
                </div>

                <!-- åŸå§‹éœ€æ±‚ -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">åŸå§‹éœ€æ±‚</h>
                    <div id="original-prompt" class="p-3 bg-slate-50 dark:bg-slate-700/30 rounded-lg text-sm text-slate-700 dark:text-slate-300"></div>
                </div>

                <!-- ä¼˜åŒ–åæç¤ºè¯ -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">
                        AIä¼˜åŒ–åæç¤ºè¯ <span class="text-xs text-primary">(æ¨¡å‹ç²¾å‡†ä¼˜åŒ–)</span>
                    </h4>
                    <div class="relative">
                        <textarea 
                            id="result-area" 
                            class="w-full h-40 md:h-48 p-4 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 readonly:cursor-default dark:text-slate-100 dark:placeholder-slate-400"
                            readonly
                            placeholder="ç‚¹å‡»ã€Œä¸€é”®ç”Ÿæˆã€ï¼Œæ¯«ç§’çº§è¾“å‡ºä¼˜åŒ–åæç¤ºè¯..."
                        ></textarea>
                        <button 
                            id="copy-btn" 
                            class="absolute top-3 right-3 bg-primary/90 text-white p-2 rounded-lg btn-hover"
                            title="å¤åˆ¶æç¤ºè¯"
                        >
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- ä¼˜åŒ–å»ºè®® -->
                <div id="suggestion-card" class="p-4 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-700/30 hidden">
                    <h4 class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-2 flex items-center gap-2">
                        <i class="fas fa-lightbulb text-warning"></i> ä¼˜åŒ–å»ºè®®
                    </h4>
                    <div id="suggestion-content" class="text-sm text-slate-700 dark:text-slate-300 space-y-2"></div>
                </div>

                <!-- å¤åˆ¶æç¤º -->
                <p id="copy-tip" class="text-success dark:text-green-400 text-sm mt-3 hidden flex items-center gap-1">
                    <i class="fas fa-check"></i> å¤åˆ¶æˆåŠŸï¼
                </p>
            </div>

            <!-- 5. å†å²è®°å½•åŒº -->
            <div class="border-t border-slate-200 dark:border-slate-700 pt-8">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-slate-700 dark:text-slate-200 font-medium flex items-center gap-2">
                        <i class="fas fa-history text-primary"></i> ç”Ÿæˆå†å²ï¼ˆæœ€è¿‘10æ¡ï¼‰
                    </h3>
                    <button id="clear-history" class="text-sm text-secondary dark:text-slate-400 hover:text-danger dark:hover:text-danger btn-hover">
                        <i class="fas fa-trash-alt"></i> æ¸…ç©ºå†å²
                    </button>
                </div>
                <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    <div id="empty-history" class="text-center py-8 text-slate-400 dark:text-slate-500">
                        <i class="fas fa-inbox text-2xl mb-2"></i>
                        <p>æš‚æ— ç”Ÿæˆè®°å½•ï¼Œç‚¹å‡»ã€Œä¸€é”®ç”Ÿæˆã€å¼€å§‹å§ï½</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨ -->
    <footer class="bg-slate-800 dark:bg-slate-900 text-white dark:text-slate-300 py-4 px-6 text-center text-sm border-t dark:border-slate-800">
        <p>AIæç¤ºè¯æé€Ÿç”Ÿæˆå™¨ | æœ¬åœ°æ¯«ç§’çº§ä¼˜åŒ– + çœŸå®APIå¯¹æ¥ | çº¯å‰ç«¯æ— æ•°æ®ä¸Šä¼ </p>
        <p class="mt-1 text-slate-400 dark:text-slate-500">Â© 2026 é©¬å¹´ä¸“å± Â· æé€Ÿæç¤ºè¯å·¥å…·</p>
    </footer>

    <!-- ğŸ”„ åŠ è½½å¼¹çª—ï¼ˆä»…APIå¼‚æ­¥è°ƒç”¨æ—¶æ˜¾ç¤ºï¼‰ -->
    <div id="loading-modal" class="loading-overlay">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-6 w-full max-w-sm shadow-2xl">
            <div class="flex flex-col items-center justify-center gap-4">
                <div class="w-12 h-12 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div>
                <h3 class="text-lg font-bold text-slate-800 dark:text-white">AIæ¨¡å‹å¤„ç†ä¸­</h3>
                <p class="text-center text-slate-600 dark:text-slate-400 text-sm">
                    æ­£åœ¨è°ƒç”¨çœŸå®AIæ¨¡å‹ï¼Œè¯·ç¨å€™...
                </p>
            </div>
        </div>
    </div>

    <!-- JavaScriptæ ¸å¿ƒé€»è¾‘ï¼ˆé‡ç‚¹ä¿®å¤ï¼‰ -->
    <script>
        // ========== å…ƒç´ è·å– ==========
        const elems = {
            userNeed: document.getElementById('user-need'),
            generateBtn: document.getElementById('generate-btn'),
            clearBtn: document.getElementById('clear-btn'),
            resultArea: document.getElementById('result-area'),
            originalPrompt: document.getElementById('original-prompt'),
            copyBtn: document.getElementById('copy-btn'),
            copyTip: document.getElementById('copy-tip'),
            themeToggle: document.getElementById('theme-toggle'),
            modelMode: document.getElementById('model-mode'),
            aiModelType: document.getElementById('ai-model-type'),
            wordCount: document.getElementById('word-count'),
            promptStyle: document.getElementById('prompt-style'),
            apiConfig: document.getElementById('api-config'),
            apiKey: document.getElementById('api-key'),
            apiUrl: document.getElementById('api-url'),
            resultScore: document.getElementById('result-score'),
            scoreValue: document.getElementById('score-value'),
            suggestionCard: document.getElementById('suggestion-card'),
            suggestionContent: document.getElementById('suggestion-content'),
            loadingModal: document.getElementById('loading-modal'),
            historyList: document.getElementById('history-list'),
            emptyHistory: document.getElementById('empty-history'),
            clearHistory: document.getElementById('clear-history')
        };

        // å­˜å‚¨key
        const HISTORY_KEY = 'aiPromptHistory_Fast';
        const THEME_KEY = 'aiPromptTheme';
        const MODEL_MODE_KEY = 'aiModelMode';

        // ========== åˆå§‹åŒ– ==========
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initModelMode();
            renderHistory();
            elems.userNeed.focus();
            // åˆå§‹éšè—åŠ è½½å¼¹çª—ï¼ˆå…³é”®ï¼šé˜²æ­¢é¡µé¢åŠ è½½æ—¶è¯¯è§¦å‘ï¼‰
            elems.loadingModal.classList.add('hidden');
        });

        // ========== 1. æ¨¡å‹æ¨¡å¼åˆ‡æ¢ï¼ˆä»…æ§åˆ¶UIæ˜¾ç¤ºï¼Œä¸å½±å“åŠ è½½é€»è¾‘ï¼‰ ==========
        function initModelMode() {
            const savedMode = localStorage.getItem(MODEL_MODE_KEY) || 'local';
            elems.modelMode.value = savedMode;
            toggleApiConfig(savedMode);

            elems.modelMode.addEventListener('change', (e) => {
                const mode = e.target.value;
                localStorage.setItem(MODEL_MODE_KEY, mode);
                toggleApiConfig(mode);
            });
        }

        function toggleApiConfig(mode) {
            elems.apiConfig.classList.toggle('hidden', mode !== 'api');
        }

        // ========== 2. æ·±è‰²æ¨¡å¼ ==========
        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme === 'dark' || (savedTheme === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.add('light');
            }
        }

        elems.themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            document.documentElement.classList.toggle('dark', !isDark);
            localStorage.setItem(THEME_KEY, isDark ? 'light' : 'dark');
        });

        // ========== 3. æ ¸å¿ƒï¼šæœ¬åœ°æé€ŸAIæ¨¡å‹ï¼ˆæ¯«ç§’çº§æ‰§è¡Œï¼Œæ— å»¶è¿Ÿï¼‰ ==========
        /**
         * æœ¬åœ°æé€ŸAIæ¨¡å‹ï¼šåŒæ­¥æ‰§è¡Œï¼Œæ— å¼‚æ­¥ç­‰å¾…ï¼Œæ ¸å¿ƒèƒ½åŠ›ä¿ç•™
         * @param {string} need - ç”¨æˆ·éœ€æ±‚
         * @param {string} modelType - æ¨¡å‹ç±»å‹
         * @param {string} count - å­—æ•°é™åˆ¶
         * @param {string} style - é£æ ¼è¦æ±‚
         * @returns {Object} { optimizedPrompt, score, suggestions }
         */
        function localAIModel(need, modelType, count, style) {
            // åŸºç¡€é…ç½®ï¼ˆæç®€å¤„ç†ï¼Œæå‡é€Ÿåº¦ï¼‰
            const styleText = style.trim() ? `ï¼Œé£æ ¼ï¼š${style.trim()}` : '';
            const countText = count !== 'unlimited' ? `ï¼Œå­—æ•°â‰¤${count}` : '';

            // 1. æ¨¡å‹ä¸“å±åŸºç¡€æç¤ºè¯ï¼ˆæ ¸å¿ƒé€»è¾‘ä¿ç•™ï¼Œä»£ç ç®€åŒ–ï¼‰
            let basePrompt = '';
            switch (modelType) {
                case 'painting':
                    basePrompt = `ã€ç»˜ç”»æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼š8Kè¶…é«˜æ¸…ã€é»„é‡‘æ¯”ä¾‹æ„å›¾ã€ç²¾å‡†å…‰å½±æ°›å›´${styleText}${countText}ï¼Œé€‚é…MJ/SDç”Ÿæˆã€‚`;
                    break;
                case 'writing':
                    basePrompt = `ã€æ–‡æ¡ˆæç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼šè´´åˆåœºæ™¯ã€è¯­æ°”é€‚é…å—ä¼—ã€æœ‰æ„ŸæŸ“åŠ›${styleText}${countText}ï¼Œé€‚é…å°çº¢ä¹¦/å…¬ä¼—å·ã€‚`;
                    break;
                case 'coding':
                    basePrompt = `ã€ç¼–ç¨‹æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼šæ˜ç¡®è¯­è¨€/æ¡†æ¶ã€å¯ç›´æ¥è¿è¡Œã€æ³¨é‡Šæ¸…æ™°${styleText}${countText}ï¼Œé€‚é…Copilotã€‚`;
                    break;
                default:
                    basePrompt = `ã€é€šç”¨æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼šç²¾å‡†åŒ¹é…éœ€æ±‚ã€ç»†èŠ‚ä¸°å¯Œ${styleText}${countText}ï¼Œé€‚é…é€šç”¨å¤§æ¨¡å‹ã€‚`;
            }

            // 2. æé€Ÿä¼˜åŒ–ï¼šä»…è¡¥å……æ ¸å¿ƒç¼ºå¤±ç»´åº¦ï¼ˆæ— å†—ä½™é€»è¾‘ï¼‰
            const optimizedPrompt = smartFastOptimize(basePrompt, modelType);

            // 3. æé€Ÿè¯„åˆ†ï¼ˆ4ç»´åº¦ç®€åŒ–ç®—æ³•ï¼Œæ¯«ç§’çº§è®¡ç®—ï¼‰
            const score = fastCalculateScore(need, optimizedPrompt, modelType, count);

            // 4. æç®€å»ºè®®ï¼ˆ3æ¡æ ¸å¿ƒå»ºè®®ï¼Œå¿«é€Ÿç”Ÿæˆï¼‰
            const suggestions = fastGenerateSuggestions(score, modelType, count, optimizedPrompt.length);

            return { optimizedPrompt, score, suggestions };
        }

        // æé€Ÿä¼˜åŒ–å‡½æ•°
        function smartFastOptimize(prompt, modelType) {
            // ç»˜ç”»æ¨¡å‹ï¼šå¿…è¡¥åˆ†è¾¨ç‡/æ„å›¾
            if (modelType === 'painting') {
                if (!prompt.includes('8K') && !prompt.includes('4K')) prompt += ' 8Kè¶…é«˜æ¸…ï¼Œç»†èŠ‚æ‹‰æ»¡ï¼›';
                if (!prompt.includes('æ„å›¾')) prompt += ' é»„é‡‘æ¯”ä¾‹æ„å›¾ï¼Œä¸»ä½“çªå‡ºï¼›';
            }
            // æ–‡æ¡ˆæ¨¡å‹ï¼šå¿…è¡¥å—ä¼—/åœºæ™¯
            else if (modelType === 'writing') {
                if (!prompt.includes('å—ä¼—')) prompt += ' å—ä¼—ï¼šå¹´è½»äºº/èŒåœºäººï¼Œè¯­æ°”äº²åˆ‡ï¼›';
                if (!prompt.includes('åœºæ™¯')) prompt += ' åœºæ™¯ï¼šæœ‹å‹åœˆ/å°çº¢ä¹¦ï¼Œé€‚é…ä¼ æ’­ï¼›';
            }
            // ç¼–ç¨‹æ¨¡å‹ï¼šå¿…è¡¥è¯­è¨€/æ¡†æ¶
            else if (modelType === 'coding') {
                if (!prompt.includes('è¯­è¨€')) prompt += ' è¯­è¨€ï¼šPython/JSï¼Œé€‚é…ä¸»æµç‰ˆæœ¬ï¼›';
                if (!prompt.includes('æ¡†æ¶')) prompt += ' æ— é¢å¤–ä¾èµ–ï¼Œå¯ç›´æ¥è¿è¡Œï¼›';
            }
            // å»é‡ã€ç²¾ç®€
            return prompt.replace(/ï¼Œ+/g, 'ï¼Œ').trim() + (prompt.endsWith('ã€‚') ? '' : 'ã€‚');
        }

        // æé€Ÿè¯„åˆ†å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼Œä¿ç•™æ ¸å¿ƒç»´åº¦ï¼‰
        function fastCalculateScore(need, prompt, modelType, count) {
            let score = 65; // åŸºç¡€åˆ†65ï¼Œæå‡åˆå§‹è¯„åˆ†
            const needLen = need.length;
            const promptLen = prompt.length;

            // 1. ç²¾å‡†åº¦ï¼ˆ+15åˆ†ï¼‰
            const keyWords = need.split(/\s+|[ï¼Œã€‚ï¼ï¼Ÿ]/).filter(Boolean);
            const matchRate = keyWords.filter(word => prompt.includes(word)).length / keyWords.length;
            score += Math.min(15, matchRate * 15);

            // 2. æ¨¡å‹é€‚é…æ€§ï¼ˆ+15åˆ†ï¼‰
            let modelScore = 0;
            if (modelType === 'painting') modelScore = prompt.includes('8K') && prompt.includes('æ„å›¾') ? 15 : 8;
            else if (modelType === 'writing') modelScore = prompt.includes('å—ä¼—') && prompt.includes('åœºæ™¯') ? 15 : 8;
            else if (modelType === 'coding') modelScore = prompt.includes('è¯­è¨€') && prompt.includes('æ¡†æ¶') ? 15 : 8;
            else modelScore = prompt.includes('é€‚é…') ? 15 : 8;
            score += modelScore;

            // 3. å­—æ•°åˆç†æ€§ï¼ˆ+10åˆ†ï¼‰
            if (count === 'unlimited') {
                score += promptLen > 80 && promptLen < 250 ? 10 : 5;
            } else {
                const limit = Number(count);
                score += promptLen <= limit && promptLen >= limit * 0.4 ? 10 : 5;
            }

            // 4. å®Œæ•´æ€§ï¼ˆ+10åˆ†ï¼‰
            score += prompt.includes('è¦æ±‚ï¼š') ? 10 : 5;

            return Math.min(100, Math.max(0, score));
        }

        // æé€Ÿå»ºè®®å‡½æ•°ï¼ˆæç®€ï¼Œ3æ¡æ ¸å¿ƒå»ºè®®ï¼‰
        function fastGenerateSuggestions(score, modelType, count, promptLen) {
            const suggestions = [];
            // åŸºç¡€è¯„åˆ†å»ºè®®
            if (score >= 90) suggestions.push('âœ… æç¤ºè¯è´¨é‡ä¼˜ç§€ï¼Œå¯ç›´æ¥ä½¿ç”¨ï¼');
            else if (score >= 75) suggestions.push('ğŸ’¡ æç¤ºè¯è´¨é‡è‰¯å¥½ï¼Œè¡¥å……ç»†èŠ‚å¯æ›´ç²¾å‡†');
            else suggestions.push('âš ï¸ å»ºè®®è¡¥å……éœ€æ±‚æ ¸å¿ƒç»†èŠ‚ï¼Œæå‡é€‚é…åº¦');

            // æ¨¡å‹ä¸“å±å»ºè®®
            if (modelType === 'painting') suggestions.push('ğŸ¨ è¡¥å……ã€Œå…‰å½±ç±»å‹ã€å¯æå‡ç”»é¢æ°›å›´æ„Ÿ');
            else if (modelType === 'writing') suggestions.push('âœï¸ æ˜ç¡®ã€Œå‘å¸ƒå¹³å°ã€å¯ä¼˜åŒ–æ–‡æ¡ˆè¯­æ°”');
            else if (modelType === 'coding') suggestions.push('ğŸ’» æŒ‡å®šã€Œç‰ˆæœ¬å·ã€å¯æå‡ä»£ç å…¼å®¹æ€§');

            // å­—æ•°å»ºè®®
            const limit = elems.wordCount.value;
            if (limit !== 'unlimited') {
                const num = Number(limit);
                if (promptLen > num) suggestions.push(`ğŸ“ ç²¾ç®€å†…å®¹ï¼Œæ§åˆ¶åœ¨${num}å­—ä»¥å†…`);
                else if (promptLen < num * 0.5) suggestions.push(`ğŸ“ è¡¥å……ç»†èŠ‚ï¼Œè¾¾åˆ°${num}å­—åˆç†èŒƒå›´`);
            }

            return suggestions.slice(0, 3);
        }

        // ========== 4. çœŸå®APIæ¨¡å‹è°ƒç”¨ï¼ˆä¿ç•™ï¼ŒåŠ è½½ä»…åœ¨æ­¤å¤„è§¦å‘ï¼‰ ==========
        async function apiAIModel(need, modelType, count, style) {
            if (!elems.apiKey.value.trim()) throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„API Keyï¼');

            // æ˜¾ç¤ºåŠ è½½å¼¹çª—ï¼ˆä»…æ­¤å¤„è§¦å‘åŠ è½½ï¼‰
            elems.loadingModal.classList.remove('hidden');

            try {
                const requestData = {
                    model: "qwen-max",
                    input: {
                        messages: [
                            {
                                role: "system",
                                content: `ä½ æ˜¯ä¸“ä¸šæç¤ºè¯ä¼˜åŒ–ä¸“å®¶ï¼ŒæŒ‰æ¨¡å‹ç±»å‹ç”Ÿæˆç²¾å‡†æç¤ºè¯ï¼Œè¾“å‡ºæ ¼å¼ï¼šä¼˜åŒ–åæç¤ºè¯|è¯„åˆ†|å»ºè®®1|å»ºè®®2|å»ºè®®3`
                            },
                            {
                                role: "user",
                                content: `éœ€æ±‚ï¼š${need}\næ¨¡å‹ï¼š${modelType}\nå­—æ•°ï¼š${count}\né£æ ¼ï¼š${style || 'æ— '}ã€‚æŒ‰æŒ‡å®šæ ¼å¼è¾“å‡ºã€‚`
                            }
                        ]
                    },
                    parameters: { result_format: "message" }
                };

                const response = await fetch(elems.apiUrl.value, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${elems.apiKey.value.trim()}`
                    },
                    body: JSON.stringify(requestData)
                });

                const res = await response.json();
                if (res.code) throw new Error(res.message);

                const result = res.output.choices[0].message.content.split('|');
                const optimizedPrompt = result[0] || '';
                const score = Number(result[1]) || 75;
                const suggestions = result.slice(2, 5).filter(Boolean);

                // éšè—åŠ è½½å¼¹çª—
                elems.loadingModal.classList.add('hidden');
                return { optimizedPrompt, score, suggestions };
            } catch (err) {
                // å¤±è´¥è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°æ¨¡å‹
                elems.loadingModal.classList.add('hidden');
                alert(`APIè°ƒç”¨å¤±è´¥ï¼š${err.message}\nå·²è‡ªåŠ¨åˆ‡æ¢è‡³æœ¬åœ°æé€Ÿæ¨¡å‹`);
                return localAIModel(need, modelType, count, style);
            }
        }

        // ========== 5. ç”ŸæˆæŒ‰é’®æ ¸å¿ƒé€»è¾‘ï¼ˆå…³é”®ï¼šä»…æ­¤å¤„è§¦å‘åŠ è½½ï¼‰ ==========
        elems.generateBtn.addEventListener('click', async () => {
            const need = elems.userNeed.value.trim();
            // è¾“å…¥éªŒè¯
            if (!need) {
                alert('è¯·è¾“å…¥æ ¸å¿ƒéœ€æ±‚åå†ç”Ÿæˆï¼');
                elems.userNeed.focus();
                return;
            }

            // æŒ‰é’®ç¦ç”¨ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            elems.generateBtn.disabled = true;
            elems.generateBtn.classList.add('opacity-70', 'cursor-not-allowed');

            try {
                const modelType = elems.aiModelType.value;
                const count = elems.wordCount.value;
                const style = elems.promptStyle.value;

                let aiResult;
                // åŒºåˆ†æ¨¡å‹æ¨¡å¼ï¼šæœ¬åœ°ï¼ˆåŒæ­¥ï¼Œæ— åŠ è½½ï¼‰ / APIï¼ˆå¼‚æ­¥ï¼Œæœ‰åŠ è½½ï¼‰
                if (elems.modelMode.value === 'local') {
                    // æœ¬åœ°æ¨¡å‹ï¼šåŒæ­¥æ¯«ç§’çº§æ‰§è¡Œï¼Œæ— åŠ è½½å¼¹çª—
                    aiResult = localAIModel(need, modelType, count, style);
                    // ç›´æ¥å±•ç¤ºç»“æœï¼Œæ— ç­‰å¾…
                    renderResult(aiResult);
                } else {
                    // APIæ¨¡å‹ï¼šå¼‚æ­¥è°ƒç”¨ï¼Œæ˜¾ç¤ºåŠ è½½å¼¹çª—
                    aiResult = await apiAIModel(need, modelType, count, style);
                    // éšè—åŠ è½½åå±•ç¤ºç»“æœ
                    renderResult(aiResult);
                }

                // ä¿å­˜å†å²è®°å½•
                saveHistory(need, aiResult.optimizedPrompt, aiResult.score, aiResult.suggestions);
            } catch (err) {
                alert(`ç”Ÿæˆå¤±è´¥ï¼š${err.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                elems.generateBtn.disabled = false;
                elems.generateBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });

        // ========== 6. ç»“æœæ¸²æŸ“å‡½æ•°ï¼ˆç»Ÿä¸€å¤„ç†ç»“æœå±•ç¤ºï¼‰ ==========
        function renderResult({ optimizedPrompt, score, suggestions }) {
            // å¡«å……åŸå§‹éœ€æ±‚å’Œä¼˜åŒ–ç»“æœ
            elems.originalPrompt.textContent = elems.userNeed.value.trim();
            elems.resultArea.value = optimizedPrompt;

            // æ˜¾ç¤ºè¯„åˆ†å’Œå»ºè®®
            elems.resultScore.classList.remove('hidden');
            elems.scoreValue.textContent = score;
            elems.suggestionCard.classList.remove('hidden');
            elems.suggestionContent.innerHTML = '';
            suggestions.forEach(sug => {
                elems.suggestionContent.innerHTML += `<p>${sug}</p>`;
            });

            // æ»šåŠ¨åˆ°ç»“æœåŒº
            elems.resultArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ========== 7. å¤åˆ¶åŠŸèƒ½ ==========
        elems.copyBtn.addEventListener('click', async () => {
            const text = elems.resultArea.value.trim();
            if (!text) {
                alert('æš‚æ— ä¼˜åŒ–åæç¤ºè¯ï¼Œæ— æ³•å¤åˆ¶ï¼');
                return;
            }
            try {
                await navigator.clipboard.writeText(text);
                elems.copyTip.classList.remove('hidden');
                setTimeout(() => elems.copyTip.classList.add('hidden'), 1500);
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼');
            }
        });

        // ========== 8. æ¸…ç©ºåŠŸèƒ½ ==========
        elems.clearBtn.addEventListener('click', () => {
            elems.userNeed.value = '';
            elems.resultArea.value = '';
            elems.originalPrompt.textContent = '';
            elems.resultScore.classList.add('hidden');
            elems.suggestionCard.classList.add('hidden');
            elems.copyTip.classList.add('hidden');
            elems.userNeed.focus();
        });

        // ========== 9. å†å²è®°å½•åŠŸèƒ½ ==========
        function saveHistory(need, optimizedPrompt, score, suggestions) {
            try {
                const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                const newRecord = {
                    id: Date.now(),
                    time: new Date().toLocaleString(),
                    need: need,
                    optimizedPrompt: optimizedPrompt,
                    score: score,
                    suggestions: suggestions
                };
                history.unshift(newRecord);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 10)));
                renderHistory();
            } catch (err) {
                console.error('ä¿å­˜å†å²å¤±è´¥ï¼š', err);
            }
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            elems.historyList.innerHTML = '';

            if (history.length === 0) {
                elems.historyList.appendChild(elems.emptyHistory);
                return;
            }

            elems.emptyHistory.remove();
            history.forEach(record => {
                const historyItem = document.createElement('div');
                const scoreClass = record.score >= 90 ? 'bg-success/10 text-success' : record.score >= 75 ? 'bg-warning/10 text-warning' : 'bg-danger/10 text-danger';
                historyItem.className = 'p-4 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 card-hover';
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-xs text-secondary dark:text-slate-400">${record.time}</span>
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${scoreClass}">
                            ${record.score}åˆ†
                        </span>
                    </div>
                    <div class="text-sm text-slate-700 dark:text-slate-300 mb-2 line-clamp-1">éœ€æ±‚ï¼š${record.need}</div>
                    <div class="text-xs text-slate-600 dark:text-slate-400 line-clamp-2 bg-white/50 dark:bg-slate-600/30 p-2 rounded mb-2">ä¼˜åŒ–åï¼š${record.optimizedPrompt}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-500">å»ºè®®ï¼š${record.suggestions[0] || 'æ— '}</div>
                    <div class="flex gap-2 mt-2">
                        <button class="history-copy text-xs px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20" data-id="${record.id}">
                            <i class="fas fa-copy mr-1"></i>å¤åˆ¶
                        </button>
                        <button class="history-delete text-xs px-2 py-1 bg-danger/10 text-danger rounded hover:bg-danger/20" data-id="${record.id}">
                            <i class="fas fa-trash mr-1"></i>åˆ é™¤
                        </button>
                    </div>
                `;
                elems.historyList.appendChild(historyItem);
            });
            bindHistoryEvents();
        }

        function bindHistoryEvents() {
            // å¤åˆ¶å†å²
            document.querySelectorAll('.history-copy').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = Number(e.target.closest('button').dataset.id);
                    const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                    const record = history.find(item => item.id === id);
                    if (record) {
                        await navigator.clipboard.writeText(record.optimizedPrompt);
                        elems.copyTip.classList.remove('hidden');
                        setTimeout(() => elems.copyTip.classList.add('hidden'), 1500);
                    }
                });
            });
            // åˆ é™¤å†å²
            document.querySelectorAll('.history-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
                    const id = Number(e.target.closest('button').dataset.id);
                    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                    history = history.filter(item => item.id !== id);
                    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                    renderHistory();
                });
            });
        }

        // æ¸…ç©ºå†å²
        elems.clearHistory.addEventListener('click', () => {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            localStorage.removeItem(HISTORY_KEY);
            renderHistory();
        });

        // ========== 10. å¿«æ·ç”Ÿæˆï¼šCtrl+Enter ==========
        elems.userNeed.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                elems.generateBtn.click();
            }
        });
    </script>
</body>
</html>
