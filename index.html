<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæç¤ºè¯ç”Ÿæˆå™¨ - æ™ºèƒ½ä¼˜åŒ–ç‰ˆ</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Tailwindé…ç½®ï¼šæ·±è‰²æ¨¡å¼+è‡ªå®šä¹‰æ ·å¼ -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb', // ä¸»è‰²ï¼šæ·±è“ï¼ˆæ›´ä¸“ä¸šï¼‰
                        secondary: '#475569',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    keyframes: {
                        pulse: {
                            '0%, 100%': { opacity: 1 },
                            '50%': { opacity: 0.5 },
                        },
                        spin: {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        }
                    },
                    animation: {
                        pulse: 'pulse 1.5s ease-in-out infinite',
                        spin: 'spin 1s linear infinite',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .input-focus { @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none; }
            .btn-hover { @apply hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300; }
            .card-hover { @apply hover:shadow-md hover:border-primary/30 transition-all duration-200; }
            .loading-shimmer { @apply bg-gradient-to-r from-transparent via-slate-200 dark:via-slate-700 to-transparent bg-[length:200%_100%] animate-shimmer; }
            @keyframes shimmer {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
        }
        /* å…¨å±€æ ·å¼ */
        html { transition: background-color 0.3s ease, color 0.3s ease; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-400 rounded-full dark:bg-slate-600; }
        ::-webkit-scrollbar-track { @apply bg-slate-100 dark:bg-slate-800; }
        /* åŠ è½½å¼¹çª—é®ç½© */
        .loading-overlay {
            @apply fixed inset-0 bg-black/50 dark:bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm;
        }
        /* è¯„åˆ†æ˜Ÿçº§æ ·å¼ */
        .star-active { @apply text-warning; }
        .star-inactive { @apply text-slate-300 dark:text-slate-700; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen flex flex-col transition-colors duration-300">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white dark:bg-slate-800 shadow-sm py-4 px-6 dark:border-b dark:border-slate-700">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold flex items-center gap-2">
                <i class="fas fa-robot text-primary"></i>
                AIæç¤ºè¯æ™ºèƒ½ç”Ÿæˆå™¨
            </h1>
            <div class="flex items-center gap-4">
                <!-- æ¨¡å‹æ¨¡å¼åˆ‡æ¢ï¼šæœ¬åœ°/çœŸå®API -->
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-secondary dark:text-slate-400 hidden sm:inline">æ¨¡å‹æ¨¡å¼ï¼š</span>
                    <select id="model-mode" class="bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-1.5 text-sm input-focus">
                        <option value="local">æœ¬åœ°æ™ºèƒ½ä¼˜åŒ–ï¼ˆå…è´¹ï¼‰</option>
                        <option value="api">çœŸå®AIæ¨¡å‹ï¼ˆéœ€APIï¼‰</option>
                    </select>
                </div>
                <!-- æ·±è‰²æ¨¡å¼åˆ‡æ¢ -->
                <button id="theme-toggle" class="bg-primary/10 dark:bg-primary/20 p-2 rounded-full btn-hover" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼">
                    <i class="fas fa-sun text-yellow-500 dark:hidden"></i>
                    <i class="fas fa-moon text-slate-200 hidden dark:inline"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-grow py-8 px-6">
        <div class="max-w-5xl mx-auto bg-white dark:bg-slate-800 rounded-xl shadow-md dark:shadow-slate-700/20 p-6 md:p-8 border dark:border-slate-700">
            <!-- 1. AIæ¨¡å‹é…ç½®åŒº -->
            <div class="mb-6 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                <h3 class="text-slate-700 dark:text-slate-200 font-medium mb-3 flex items-center gap-2">
                    <i class="fas fa-cogs text-primary"></i> AIæ¨¡å‹é…ç½®
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- AIæ¨¡å‹é€‰æ‹© -->
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">AIæ¨¡å‹ç±»å‹</label>
                        <select id="ai-model-type" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg input-focus bg-white dark:bg-slate-600 dark:text-slate-100">
                            <option value="general">é€šç”¨å¤§æ¨¡å‹ï¼ˆChatGPT/æ–‡å¿ƒä¸€è¨€ï¼‰</option>
                            <option value="painting">ç»˜ç”»æ¨¡å‹ï¼ˆMJ/SD/æ–‡å¿ƒä¸€æ ¼ï¼‰</option>
                            <option value="writing">æ–‡æ¡ˆæ¨¡å‹ï¼ˆå°çº¢ä¹¦/å…¬ä¼—å·ï¼‰</option>
                            <option value="coding">ç¼–ç¨‹æ¨¡å‹ï¼ˆCopilot/CodeLlamaï¼‰</option>
                        </select>
                    </div>
                    <!-- æç¤ºè¯å‚æ•° -->
                    <div>
                        <label class="block text-slate-700 dark:text-slate-300 text-sm font-medium mb-2">æ ¸å¿ƒå‚æ•°</label>
                        <div class="grid grid-cols-2 gap-2">
                            <select id="word-count" class="p-3 border border-slate-300 dark:border-slate-600 rounded-lg input-focus bg-white dark:bg-slate-600 dark:text-slate-100">
                                <option value="unlimited">ä¸é™å­—æ•°</option>
                                <option value="50">50å­—å†…</option>
                                <option value="100">100å­—å†…</option>
                                <option value="200">200å­—å†…</option>
                                <option value="300">300å­—å†…</option>
                            </select>
                            <input type="text" id="prompt-style" placeholder="é£æ ¼ï¼šèµ›åšæœ‹å…‹/æ²»æ„ˆ..." class="p-3 border border-slate-300 dark:border-slate-600 rounded-lg input-focus bg-white dark:bg-slate-600 dark:text-slate-100">
                        </div>
                    </div>
                </div>
                <!-- APIé…ç½®åŒºï¼ˆé»˜è®¤éšè—ï¼Œåˆ‡æ¢åˆ°çœŸå®APIæ—¶æ˜¾ç¤ºï¼‰ -->
                <div id="api-config" class="mt-4 p-3 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800/50 hidden">
                    <label class="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">APIé…ç½®ï¼ˆä»¥é€šä¹‰åƒé—®ä¸ºä¾‹ï¼‰</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="text" id="api-key" placeholder="è¾“å…¥ä½ çš„API Key" class="p-2 border rounded-lg input-focus text-sm">
                        <input type="text" id="api-url" placeholder="APIæ¥å£åœ°å€" value="https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation" class="p-2 border rounded-lg input-focus text-sm">
                    </div>
                    <p class="text-xs text-secondary dark:text-slate-400 mt-2">ğŸ“Œ å…è´¹APIå¯ç”³è¯·ï¼šé€šä¹‰åƒé—®ã€DeepSeekã€è±†åŒ…ç­‰</p>
                </div>
            </div>

            <!-- 2. è¾“å…¥åŒºåŸŸ -->
            <div class="mb-6">
                <label for="user-need" class="block text-slate-700 dark:text-slate-200 font-medium mb-2">
                    ä½ çš„æ ¸å¿ƒéœ€æ±‚ <span class="text-danger dark:text-red-400">*</span>
                </label>
                <textarea 
                    id="user-need" 
                    class="w-full h-32 md:h-40 p-4 border border-slate-300 dark:border-slate-600 rounded-lg input-focus resize-y bg-white dark:bg-slate-600 dark:text-slate-100 dark:placeholder-slate-400"
                    placeholder="ä¾‹ï¼šç”Ÿæˆä¸€å¼ èµ›åšæœ‹å…‹é£æ ¼çš„åŸå¸‚å¤œæ™¯å›¾ï¼Œè¦æœ‰éœ“è™¹ç¯å…‰ã€é›¨å¤©æ°›å›´ã€æœªæ¥æ„Ÿå»ºç­‘ï¼›æˆ–å†™ä¸€ç¯‡å…³äºé©¬å¹´æ˜¥èŠ‚çš„æœ‹å‹åœˆæ–‡æ¡ˆ..."
                ></textarea>
                <p class="text-xs text-secondary dark:text-slate-400 mt-2">ğŸ’¡ éœ€æ±‚è¶Šå…·ä½“ï¼ŒAIæ¨¡å‹ä¼˜åŒ–æ•ˆæœè¶Šå¥½ï¼</p>
            </div>

            <!-- 3. æ“ä½œæŒ‰é’®åŒº -->
            <div class="flex gap-4 mb-8 flex-wrap">
                <button id="generate-btn" class="bg-primary text-white px-6 py-3 rounded-lg font-medium btn-hover flex items-center gap-2">
                    <i class="fas fa-rocket"></i> å¯åŠ¨AIæ¨¡å‹ç”Ÿæˆ
                </button>
                <button id="clear-btn" class="bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 px-6 py-3 rounded-lg font-medium btn-hover flex items-center gap-2">
                    <i class="fas fa-trash"></i> æ¸…ç©ºå†…å®¹
                </button>
            </div>

            <!-- 4. ç»“æœå±•ç¤ºåŒºï¼ˆå«ä¼˜åŒ–åæç¤ºè¯+è¯„åˆ†+å»ºè®®ï¼‰ -->
            <div class="border-t border-slate-200 dark:border-slate-700 pt-8 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-slate-700 dark:text-slate-200 font-medium flex items-center gap-2 text-lg">
                        <i class="fas fa-check-circle text-success"></i> AIæ¨¡å‹è¾“å‡º
                    </h3>
                    <span id="result-score" class="hidden items-center gap-1 text-lg font-bold">
                        <span>è¯„åˆ†ï¼š</span>
                        <span id="score-value" class="text-warning">0</span>
                        <span>/100</span>
                    </span>
                </div>

                <!-- åŸæç¤ºè¯ -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">åŸå§‹éœ€æ±‚</h4>
                    <div id="original-prompt" class="p-3 bg-slate-50 dark:bg-slate-700/30 rounded-lg text-sm text-slate-700 dark:text-slate-300"></div>
                </div>

                <!-- ä¼˜åŒ–åæç¤ºè¯ -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">
                        AIä¼˜åŒ–åæç¤ºè¯ <span class="text-xs text-primary">(æ¨¡å‹ç²¾å‡†ä¼˜åŒ–)</span>
                    </h4>
                    <div class="relative">
                        <textarea 
                            id="result-area" 
                            class="w-full h-40 md:h-48 p-4 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 readonly:cursor-default dark:text-slate-100 dark:placeholder-slate-400"
                            readonly
                            placeholder="AIæ¨¡å‹å¤„ç†åï¼Œä¼˜åŒ–åçš„æç¤ºè¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."
                        ></textarea>
                        <button 
                            id="copy-btn" 
                            class="absolute top-3 right-3 bg-primary/90 text-white p-2 rounded-lg btn-hover"
                            title="å¤åˆ¶ä¼˜åŒ–åæç¤ºè¯"
                        >
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- ä¼˜åŒ–å»ºè®® -->
                <div id="suggestion-card" class="p-4 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-700/30 hidden">
                    <h4 class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-2 flex items-center gap-2">
                        <i class="fas fa-lightbulb text-warning"></i> AIæ¨¡å‹ä¼˜åŒ–å»ºè®®
                    </h4>
                    <div id="suggestion-content" class="text-sm text-slate-700 dark:text-slate-300 space-y-2"></div>
                </div>

                <!-- å¤åˆ¶æç¤º -->
                <p id="copy-tip" class="text-success dark:text-green-400 text-sm mt-3 hidden flex items-center gap-1">
                    <i class="fas fa-check"></i> å¤åˆ¶æˆåŠŸï¼å·²ä¿å­˜åˆ°å‰ªè´´æ¿
                </p>
            </div>

            <!-- 5. å†å²è®°å½•åŒº -->
            <div class="border-t border-slate-200 dark:border-slate-700 pt-8">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-slate-700 dark:text-slate-200 font-medium flex items-center gap-2">
                        <i class="fas fa-history text-primary"></i> AIç”Ÿæˆå†å²ï¼ˆæœ€è¿‘10æ¡ï¼‰
                    </h3>
                    <button id="clear-history" class="text-sm text-secondary dark:text-slate-400 hover:text-danger dark:hover:text-danger btn-hover">
                        <i class="fas fa-trash-alt"></i> æ¸…ç©ºå†å²
                    </button>
                </div>
                <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    <div id="empty-history" class="text-center py-8 text-slate-400 dark:text-slate-500">
                        <i class="fas fa-inbox text-2xl mb-2"></i>
                        <p>æš‚æ— AIç”Ÿæˆè®°å½•ï¼Œç‚¹å‡»ã€Œå¯åŠ¨AIæ¨¡å‹ç”Ÿæˆã€å¼€å§‹å§ï½</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨ -->
    <footer class="bg-slate-800 dark:bg-slate-900 text-white dark:text-slate-300 py-4 px-6 text-center text-sm border-t dark:border-slate-800">
        <p>AIæç¤ºè¯æ™ºèƒ½ç”Ÿæˆå™¨ | æœ¬åœ°AIä¼˜åŒ– + çœŸå®APIå¯¹æ¥ | çº¯å‰ç«¯æ— æ•°æ®ä¸Šä¼ </p>
        <p class="mt-1 text-slate-400 dark:text-slate-500">Â© 2026 é©¬å¹´ä¸“å± Â· æ™ºèƒ½æç¤ºè¯å·¥å…·</p>
    </footer>

    <!-- ğŸ”„ AIæ¨¡å‹åŠ è½½å¼¹çª—ï¼ˆæ ¸å¿ƒï¼šæ¨¡æ‹Ÿæ¨¡å‹è¿è½¬ï¼‰ -->
    <div id="loading-modal" class="loading-overlay hidden">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-8 w-full max-w-md shadow-2xl">
            <div class="flex flex-col items-center justify-center gap-6">
                <!-- åŠ è½½åŠ¨ç”» -->
                <div class="w-16 h-16 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">AIæ¨¡å‹æ­£åœ¨è¿è½¬</h3>
                <p class="text-center text-slate-600 dark:text-slate-400" id="loading-text">
                    æ­£åœ¨è§£æéœ€æ±‚ â†’ ä¼˜åŒ–æç¤ºè¯ â†’ ç”Ÿæˆç²¾å‡†ç»“æœ<br>
                    è¯·ç¨å€™ï¼Œæ¨¡å‹å¤„ç†ä¸­...
                </p>
                <!-- åŠ è½½è¿›åº¦æ¡ -->
                <div class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                    <div id="loading-progress" class="h-full bg-primary w-0 transition-all duration-2000"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScriptæ ¸å¿ƒé€»è¾‘ -->
    <script>
        // ========== å…¨å±€å˜é‡ & å…ƒç´ è·å– ==========
        const elems = {
            userNeed: document.getElementById('user-need'),
            generateBtn: document.getElementById('generate-btn'),
            clearBtn: document.getElementById('clear-btn'),
            resultArea: document.getElementById('result-area'),
            originalPrompt: document.getElementById('original-prompt'),
            copyBtn: document.getElementById('copy-btn'),
            copyTip: document.getElementById('copy-tip'),
            themeToggle: document.getElementById('theme-toggle'),
            modelMode: document.getElementById('model-mode'),
            aiModelType: document.getElementById('ai-model-type'),
            wordCount: document.getElementById('word-count'),
            promptStyle: document.getElementById('prompt-style'),
            apiConfig: document.getElementById('api-config'),
            apiKey: document.getElementById('api-key'),
            apiUrl: document.getElementById('api-url'),
            resultScore: document.getElementById('result-score'),
            scoreValue: document.getElementById('score-value'),
            suggestionCard: document.getElementById('suggestion-card'),
            suggestionContent: document.getElementById('suggestion-content'),
            loadingModal: document.getElementById('loading-modal'),
            loadingText: document.getElementById('loading-text'),
            loadingProgress: document.getElementById('loading-progress'),
            historyList: document.getElementById('history-list'),
            emptyHistory: document.getElementById('empty-history'),
            clearHistory: document.getElementById('clear-history')
        };

        const HISTORY_KEY = 'aiPromptHistoryV2';
        const THEME_KEY = 'aiPromptTheme';
        const MODEL_MODE_KEY = 'aiModelMode';

        // ========== åˆå§‹åŒ– ==========
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initModelMode();
            renderHistory();
            elems.userNeed.focus();
        });

        // ========== 1. æ¨¡å‹æ¨¡å¼åˆ‡æ¢ï¼ˆæœ¬åœ°/APIï¼‰ ==========
        function initModelMode() {
            // è¯»å–æœ¬åœ°å­˜å‚¨çš„æ¨¡å‹æ¨¡å¼
            const savedMode = localStorage.getItem(MODEL_MODE_KEY) || 'local';
            elems.modelMode.value = savedMode;
            toggleApiConfig(savedMode);

            // åˆ‡æ¢äº‹ä»¶
            elems.modelMode.addEventListener('change', (e) => {
                const mode = e.target.value;
                localStorage.setItem(MODEL_MODE_KEY, mode);
                toggleApiConfig(mode);
            });
        }

        // æ˜¾ç¤º/éšè—APIé…ç½®åŒº
        function toggleApiConfig(mode) {
            elems.apiConfig.classList.toggle('hidden', mode !== 'api');
        }

        // ========== 2. æ·±è‰²æ¨¡å¼ ==========
        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme === 'dark' || (savedTheme === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.add('light');
            }
        }

        elems.themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            if (isDark) {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
                localStorage.setItem(THEME_KEY, 'light');
            } else {
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
                localStorage.setItem(THEME_KEY, 'dark');
            }
        });

        // ========== 3. æ ¸å¿ƒï¼šAIæ¨¡å‹æ ¸å¿ƒé€»è¾‘ ==========
        /**
         * æœ¬åœ°AIæ¨¡å‹ï¼šæ¨¡æ‹ŸçœŸå®å¤§æ¨¡å‹ï¼Œä¼˜åŒ–æç¤ºè¯+ç”Ÿæˆè¯„åˆ†+å»ºè®®
         * @param {string} need - ç”¨æˆ·åŸå§‹éœ€æ±‚
         * @param {string} modelType - æ¨¡å‹ç±»å‹ï¼ˆgeneral/painting/writing/codingï¼‰
         * @param {string} count - å­—æ•°é™åˆ¶
         * @param {string} style - é£æ ¼è¦æ±‚
         * @returns {Object} { optimizedPrompt: ä¼˜åŒ–åæç¤ºè¯, score: è¯„åˆ†, suggestions: å»ºè®®æ•°ç»„ }
         */
        function localAIModel(need, modelType, count, style) {
            // åŸºç¡€é…ç½®
            const styleText = style.trim() ? `ï¼Œé£æ ¼ï¼š${style.trim()}` : '';
            const countText = count !== 'unlimited' ? `ï¼Œå­—æ•°æ§åˆ¶åœ¨${count}å­—ä»¥å†…` : '';
            const baseConfig = `${styleText}${countText}ï¼Œé€»è¾‘æ¸…æ™°ã€ç»†èŠ‚ä¸°å¯Œã€é€‚é…å¯¹åº”AIæ¨¡å‹`;

            // 1. ç”Ÿæˆæ¨¡å‹ä¸“å±åŸºç¡€æç¤ºè¯
            let basePrompt = '';
            switch (modelType) {
                case 'painting':
                    basePrompt = `ã€ç»˜ç”»ä¸“å±æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼šç”»é¢æ„Ÿå¼ºï¼ŒåŒ…å«åˆ†è¾¨ç‡ï¼ˆ8K/4Kï¼‰ã€è‰²å½©ã€æ„å›¾ã€å…‰å½±ï¼Œé€‚é…Midjourney/Stable Diffusionï¼Œ${baseConfig}ã€‚`;
                    break;
                case 'writing':
                    basePrompt = `ã€æ–‡æ¡ˆä¸“å±æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼šè´´åˆåœºæ™¯ã€è¯­æ°”é€‚é…å—ä¼—ã€æœ‰æ„ŸæŸ“åŠ›ï¼Œé€‚é…å°çº¢ä¹¦/å…¬ä¼—å·/ç”µå•†ï¼Œ${baseConfig}ã€‚`;
                    break;
                case 'coding':
                    basePrompt = `ã€ç¼–ç¨‹ä¸“å±æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼šæ˜ç¡®è¯­è¨€/æ¡†æ¶ã€æ­¥éª¤åŒ–åŠŸèƒ½ã€ç¬¦åˆå¼€å‘è§„èŒƒï¼Œé€‚é…Copilot/CodeLlamaï¼Œ${baseConfig}ã€‚`;
                    break;
                default:
                    basePrompt = `ã€é€šç”¨æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼šç²¾å‡†åŒ¹é…éœ€æ±‚ã€åŸåˆ›æœ‰ä»·å€¼ã€é€‚é…é€šç”¨å¤§æ¨¡å‹ï¼Œ${baseConfig}ã€‚`;
            }

            // 2. æ™ºèƒ½ä¼˜åŒ–ï¼šè¡¥å……ç¼ºå¤±ç»´åº¦ã€å¼ºåŒ–ç²¾å‡†æ€§
            const optimizedPrompt = smartOptimizePrompt(basePrompt, modelType);

            // 3. è´¨é‡è¯„åˆ†ï¼ˆ0-100ï¼‰ï¼šç²¾å‡†åº¦ã€å®Œæ•´æ€§ã€é€‚é…æ€§ã€å¯è¯»æ€§
            const score = calculatePromptScore(need, optimizedPrompt, modelType);

            // 4. ç”Ÿæˆä¼˜åŒ–å»ºè®®
            const suggestions = generateSuggestions(need, optimizedPrompt, score, modelType);

            return { optimizedPrompt, score, suggestions };
        }

        /**
         * çœŸå®AIæ¨¡å‹APIè°ƒç”¨ï¼ˆä»¥é€šä¹‰åƒé—®ä¸ºä¾‹ï¼Œå¯æ›¿æ¢ä¸ºä»»æ„å¤§æ¨¡å‹ï¼‰
         */
        async function apiAIModel(need, modelType, count, style) {
            if (!elems.apiKey.value.trim()) {
                throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„API Keyï¼');
            }

            // æ„å»ºAPIè¯·æ±‚å‚æ•°ï¼ˆé€‚é…é€šä¹‰åƒé—®qwen-maxæ¨¡å‹ï¼‰
            const requestData = {
                model: "qwen-max",
                input: {
                    messages: [
                        {
                            role: "system",
                            content: `ä½ æ˜¯ä¸“ä¸šçš„AIæç¤ºè¯ä¼˜åŒ–ä¸“å®¶ï¼Œæ“…é•¿æ ¹æ®ä¸åŒæ¨¡å‹ç±»å‹ï¼ˆç»˜ç”»/æ–‡æ¡ˆ/ç¼–ç¨‹/é€šç”¨ï¼‰ç”Ÿæˆç²¾å‡†ã€é«˜è´¨é‡çš„æç¤ºè¯ã€‚è¦æ±‚ï¼š1. è¡¥å……éœ€æ±‚ç¼ºå¤±çš„å…³é”®ç»´åº¦ï¼›2. é€‚é…å¯¹åº”æ¨¡å‹çš„ç”Ÿæˆè§„åˆ™ï¼›3. æ§åˆ¶å­—æ•°ï¼›4. è¯­è¨€ç²¾å‡†æ— å†—ä½™ã€‚`
                        },
                        {
                            role: "user",
                            content: `ç”¨æˆ·éœ€æ±‚ï¼š${need}\næ¨¡å‹ç±»å‹ï¼š${modelType}\nå­—æ•°è¦æ±‚ï¼š${elems.wordCount.value}\né£æ ¼è¦æ±‚ï¼š${elems.promptStyle.value || 'æ— '}\nè¯·ç”Ÿæˆä¼˜åŒ–åçš„æç¤ºè¯ï¼Œå¹¶é™„å¸¦è¯„åˆ†ï¼ˆ0-100ï¼‰å’Œ3æ¡å…·ä½“ä¼˜åŒ–å»ºè®®ã€‚`
                        }
                    ]
                },
                parameters: {
                    result_format: "message"
                }
            };

            try {
                const response = await fetch(elems.apiUrl.value, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${elems.apiKey.value.trim()}`
                    },
                    body: JSON.stringify(requestData)
                });

                const res = await response.json();
                if (res.code) throw new Error(res.message);

                // è§£æAPIè¿”å›ç»“æœï¼ˆéœ€æ ¹æ®å®é™…APIæ ¼å¼è°ƒæ•´ï¼‰
                const aiResult = res.output.choices[0].message.content;
                // è§£æè¯„åˆ†ã€å»ºè®®ã€ä¼˜åŒ–æç¤ºè¯ï¼ˆç®€å•æ­£åˆ™æå–ï¼Œå¯æ ¹æ®APIè¿”å›æ ¼å¼ä¼˜åŒ–ï¼‰
                const scoreMatch = aiResult.match(/è¯„åˆ†ï¼š(\d{1,3})/);
                const score = scoreMatch ? Number(scoreMatch[1]) : 70;
                const suggestions = aiResult.split('ä¼˜åŒ–å»ºè®®ï¼š')[1]?.split('\n').filter(Boolean) || ['è¯·å‚è€ƒæœ¬åœ°æ¨¡å‹å»ºè®®'];
                const optimizedPrompt = aiResult.split('ä¼˜åŒ–åæç¤ºè¯ï¼š')[1]?.split('è¯„åˆ†ï¼š')[0]?.trim() || aiResult;

                return { optimizedPrompt, score, suggestions };
            } catch (err) {
                throw new Error(`APIè°ƒç”¨å¤±è´¥ï¼š${err.message}\nğŸ”§ è¯·æ£€æŸ¥API Key/åœ°å€ï¼Œæˆ–åˆ‡æ¢è‡³ã€Œæœ¬åœ°æ™ºèƒ½ä¼˜åŒ–ã€æ¨¡å¼`);
            }
        }

        // ========== 4. æç¤ºè¯æ™ºèƒ½ä¼˜åŒ–æ ¸å¿ƒå‡½æ•° ==========
        function smartOptimizePrompt(prompt, modelType) {
            let optimized = prompt;

            // ç»˜ç”»æ¨¡å‹ï¼šè¡¥å……é€šç”¨ç¼ºå¤±ç»´åº¦
            if (modelType === 'painting') {
                if (!optimized.includes('åˆ†è¾¨ç‡') && !optimized.includes('8K') && !optimized.includes('4K')) {
                    optimized += ' åˆ†è¾¨ç‡ï¼š8Kè¶…é«˜æ¸…ï¼Œç»†èŠ‚æ‹‰æ»¡ï¼›';
                }
                if (!optimized.includes('æ„å›¾') && !optimized.includes('é»„é‡‘æ¯”ä¾‹')) {
                    optimized += ' æ„å›¾ï¼šé»„é‡‘æ¯”ä¾‹ï¼Œä¸»ä½“çªå‡ºï¼›';
                }
                if (!optimized.includes('å…‰å½±') && !optimized.includes('å…‰çº¿')) {
                    optimized += ' å…‰å½±ï¼šè‡ªç„¶æŸ”å…‰/éœ“è™¹å…‰å½±ï¼Œæ°›å›´æ„Ÿæ‹‰æ»¡ï¼›';
                }
            }

            // æ–‡æ¡ˆæ¨¡å‹ï¼šè¡¥å……å—ä¼—/åœºæ™¯ç»´åº¦
            if (modelType === 'writing') {
                if (!optimized.includes('å—ä¼—') && !optimized.includes('è¯»è€…')) {
                    optimized += ' å—ä¼—ï¼šå¤§ä¼—/å¹´è½»äºº/èŒåœºäººï¼Œè¯­æ°”äº²åˆ‡è‡ªç„¶ï¼›';
                }
                if (!optimized.includes('åœºæ™¯') && !optimized.includes('ä½¿ç”¨åœºæ™¯')) {
                    optimized += ' ä½¿ç”¨åœºæ™¯ï¼šæœ‹å‹åœˆ/å…¬ä¼—å·/å°çº¢ä¹¦/ç”µå•†è¯¦æƒ…é¡µï¼›';
                }
            }

            // ç¼–ç¨‹æ¨¡å‹ï¼šè¡¥å……è¯­è¨€/æ¡†æ¶ç»´åº¦
            if (modelType === 'coding') {
                if (!optimized.includes('è¯­è¨€') && !optimized.includes('Python') && !optimized.includes('JavaScript')) {
                    optimized += ' å¼€å‘è¯­è¨€ï¼šPython/JavaScriptï¼Œé€‚é…ä¸»æµç‰ˆæœ¬ï¼›';
                }
                if (!optimized.includes('æ¡†æ¶') && !optimized.includes('ä¾èµ–')) {
                    optimized += ' æ¡†æ¶/ä¾èµ–ï¼šæ— é¢å¤–ä¾èµ–ï¼Œå¯ç›´æ¥è¿è¡Œï¼›';
                }
            }

            // é€šç”¨ä¼˜åŒ–ï¼šå»é‡ã€å¼ºåŒ–é€»è¾‘ã€è¡¥å……ç»“å°¾
            optimized = optimized.replace(/ï¼Œ+/g, 'ï¼Œ').trim();
            if (!optimized.endsWith('ã€‚')) optimized += 'ã€‚';

            return optimized;
        }

        // ========== 5. æç¤ºè¯è´¨é‡è¯„åˆ† ==========
        function calculatePromptScore(need, optimizedPrompt, modelType) {
            let score = 60; // åŸºç¡€åˆ†60
            const needLen = need.length;
            const promptLen = optimizedPrompt.length;

            // 1. ç²¾å‡†åº¦ï¼šéœ€æ±‚åŒ¹é…åº¦ï¼ˆ+20åˆ†ï¼‰
            const keyWords = need.split(/\s+|[ï¼Œã€‚ï¼ï¼Ÿ]/).filter(Boolean);
            const matchCount = keyWords.filter(word => optimizedPrompt.includes(word)).length;
            score += Math.min(20, (matchCount / keyWords.length) * 20);

            // 2. å®Œæ•´æ€§ï¼šè¡¥å……ç»´åº¦ï¼ˆ+20åˆ†ï¼‰
            let completeScore = 0;
            switch (modelType) {
                case 'painting':
                    completeScore = optimizedPrompt.includes('åˆ†è¾¨ç‡') && optimizedPrompt.includes('æ„å›¾') && optimizedPrompt.includes('å…‰å½±') ? 20 : 10;
                    break;
                case 'writing':
                    completeScore = optimizedPrompt.includes('å—ä¼—') && optimizedPrompt.includes('åœºæ™¯') ? 20 : 10;
                    break;
                case 'coding':
                    completeScore = optimizedPrompt.includes('è¯­è¨€') && optimizedPrompt.includes('æ¡†æ¶') ? 20 : 10;
                    break;
                default:
                    completeScore = optimizedPrompt.includes('é€‚é…') && optimizedPrompt.includes('ç»†èŠ‚') ? 20 : 10;
            }
            score += completeScore;

            // 3. é€‚é…æ€§ï¼šæ¨¡å‹ç±»å‹åŒ¹é…ï¼ˆ+20åˆ†ï¼‰
            score += modelType === 'general' ? 15 : 20;

            // 4. å¯è¯»æ€§ï¼šå­—æ•°åˆç†ï¼ˆ+20åˆ†ï¼‰
            const count = elems.wordCount.value;
            if (count === 'unlimited') {
                score += promptLen > 50 && promptLen < 300 ? 20 : 10;
            } else {
                const limitNum = Number(count);
                score += promptLen <= limitNum && promptLen >= limitNum * 0.5 ? 20 : 10;
            }

            // 5. åŸåˆ›æ€§ï¼šæ— å†—ä½™é‡å¤ï¼ˆ+20åˆ†ï¼‰
            const uniqueRatio = new Set(optimizedPrompt.split('ï¼Œ')).size / optimizedPrompt.split('ï¼Œ').length;
            score += uniqueRatio > 0.8 ? 20 : uniqueRatio > 0.5 ? 10 : 0;

            return Math.min(100, Math.max(0, Math.round(score)));
        }

        // ========== 6. ç”Ÿæˆä¼˜åŒ–å»ºè®® ==========
        function generateSuggestions(need, optimizedPrompt, score, modelType) {
            const suggestions = [];
            const needLen = need.length;
            const promptLen = optimizedPrompt.length;

            // åŸºç¡€å»ºè®®
            if (score < 60) {
                suggestions.push('âš ï¸ æç¤ºè¯è´¨é‡è¾ƒä½ï¼Œå»ºè®®è¡¥å……éœ€æ±‚çš„**æ ¸å¿ƒç»†èŠ‚**ï¼Œæ˜ç¡®ä½¿ç”¨åœºæ™¯å’Œé£æ ¼è¦æ±‚ã€‚');
            } else if (score < 80) {
                suggestions.push('ğŸ’¡ æç¤ºè¯è´¨é‡è‰¯å¥½ï¼Œå¯è¿›ä¸€æ­¥è¡¥å……**æ¨¡å‹ä¸“å±ç»´åº¦**ï¼ˆå¦‚ç»˜ç”»çš„åˆ†è¾¨ç‡ã€æ–‡æ¡ˆçš„å—ä¼—ï¼‰ã€‚');
            } else {
                suggestions.push('âœ… æç¤ºè¯è´¨é‡ä¼˜ç§€ï¼Œå·²é€‚é…æ¨¡å‹è§„åˆ™ï¼Œå¯ç›´æ¥ä½¿ç”¨ï¼');
            }

            // æ¨¡å‹ä¸“å±å»ºè®®
            switch (modelType) {
                case 'painting':
                    if (!optimizedPrompt.includes('8K') || !optimizedPrompt.includes('æ„å›¾')) {
                        suggestions.push('ğŸ¨ ç»˜ç”»æ¨¡å‹å»ºè®®ï¼šè¡¥å……ã€Œåˆ†è¾¨ç‡ï¼ˆ8K/4Kï¼‰ã€ã€Œæ„å›¾æ–¹å¼ã€ã€Œå…‰å½±ç±»å‹ã€ï¼Œæå‡ç”Ÿæˆç”»é¢è´¨é‡ã€‚');
                    }
                    break;
                case 'writing':
                    if (!optimizedPrompt.includes('å—ä¼—') || !optimizedPrompt.includes('åœºæ™¯')) {
                        suggestions.push('âœï¸ æ–‡æ¡ˆæ¨¡å‹å»ºè®®ï¼šæ˜ç¡®**ç›®æ ‡å—ä¼—**ï¼ˆå¦‚å¹´è½»äºº/èŒåœºäººï¼‰å’Œ**ä½¿ç”¨åœºæ™¯**ï¼ˆå¦‚æœ‹å‹åœˆ/å°çº¢ä¹¦ï¼‰ï¼Œæå‡æ–‡æ¡ˆé€‚é…åº¦ã€‚');
                    }
                    break;
                case 'coding':
                    if (!optimizedPrompt.includes('è¯­è¨€') || !optimizedPrompt.includes('æ¡†æ¶')) {
                        suggestions.push('ğŸ’» ç¼–ç¨‹æ¨¡å‹å»ºè®®ï¼šæŒ‡å®š**å¼€å‘è¯­è¨€**ï¼ˆPython/JSï¼‰å’Œ**æ¡†æ¶/ä¾èµ–**ï¼Œç¡®ä¿ä»£ç å¯ç›´æ¥è¿è¡Œã€‚');
                    }
                    break;
                default:
                    suggestions.push('ğŸŒ é€šç”¨æ¨¡å‹å»ºè®®ï¼šéœ€æ±‚æè¿°è¶Šå…·ä½“ï¼ŒAIç”Ÿæˆç»“æœè¶Šç²¾å‡†ï¼Œå¯è¡¥å……ã€Œè¾“å‡ºæ ¼å¼ã€ã€Œæ ¸å¿ƒè¦æ±‚ã€ç­‰ç»†èŠ‚ã€‚');
            }

            // å­—æ•°å»ºè®®
            const count = elems.wordCount.value;
            if (count !== 'unlimited') {
                const limitNum = Number(count);
                if (promptLen > limitNum) {
                    suggestions.push(`ğŸ“ å­—æ•°å»ºè®®ï¼šå½“å‰æç¤ºè¯${promptLen}å­—ï¼Œè¶…å‡º${limit}å­—é™åˆ¶ï¼Œå»ºè®®ç²¾ç®€å†—ä½™å†…å®¹ã€‚`);
                } else if (promptLen < limitNum * 0.5) {
                    suggestions.push(`ğŸ“ å­—æ•°å»ºè®®ï¼šå½“å‰æç¤ºè¯${promptLen}å­—ï¼Œå¯è¡¥å……ç»†èŠ‚ä»¥è¾¾åˆ°${limit}å­—çš„åˆç†èŒƒå›´ã€‚`);
                }
            }

            // å»é‡å»ºè®®
            const duplicateMatch = optimizedPrompt.match(/ï¼ˆã€‚ï¼Œï¼‰+/g);
            if (duplicateMatch) {
                suggestions.push('ğŸ”„ ä¼˜åŒ–å»ºè®®ï¼šåˆ é™¤é‡å¤çš„è¡¨è¿°ï¼Œç²¾ç®€è¯­è¨€ï¼Œæå‡æç¤ºè¯å¯è¯»æ€§ã€‚');
            }

            return suggestions.slice(0, 3); // æœ€å¤šè¿”å›3æ¡å»ºè®®
        }

        // ========== 7. åŠ è½½å¼¹çª—æ§åˆ¶ ==========
        function showLoading() {
            elems.loadingModal.classList.remove('hidden');
            elems.loadingProgress.style.width = '0%';
            // æ¨¡æ‹ŸåŠ è½½è¿›åº¦
            setTimeout(() => elems.loadingProgress.style.width = '30%', 500);
            setTimeout(() => elems.loadingProgress.style.width = '60%', 1200);
            setTimeout(() => elems.loadingProgress.style.width = '100%', 1800);
        }

        function hideLoading() {
            setTimeout(() => elems.loadingModal.classList.add('hidden'), 500);
        }

        // ========== 8. ç”ŸæˆæŒ‰é’®æ ¸å¿ƒé€»è¾‘ ==========
        elems.generateBtn.addEventListener('click', async () => {
            const need = elems.userNeed.value.trim();
            if (!need) {
                alert('è¯·è¾“å…¥ä½ çš„æ ¸å¿ƒéœ€æ±‚åï¼Œå†å¯åŠ¨AIæ¨¡å‹ç”Ÿæˆï¼');
                elems.userNeed.focus();
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            elems.generateBtn.disabled = true;
            elems.generateBtn.classList.add('opacity-70', 'cursor-not-allowed');
            showLoading();

            try {
                const modelType = elems.aiModelType.value;
                const count = elems.wordCount.value;
                const style = elems.promptStyle.value;

                let aiResult;
                // é€‰æ‹©æ¨¡å‹æ¨¡å¼ï¼šæœ¬åœ°/API
                if (elems.modelMode.value === 'local') {
                    aiResult = localAIModel(need, modelType, count, style);
                } else {
                    aiResult = await apiAIModel(need, modelType, count, style);
                }

                // éšè—åŠ è½½å¼¹çª—ï¼Œå±•ç¤ºç»“æœ
                hideLoading();
                elems.generateBtn.disabled = false;
                elems.generateBtn.classList.remove('opacity-70', 'cursor-not-allowed');

                // å¡«å……ç»“æœ
                elems.originalPrompt.textContent = need;
                elems.resultArea.value = aiResult.optimizedPrompt;
                elems.resultScore.classList.remove('hidden');
                elems.scoreValue.textContent = aiResult.score;
                elems.suggestionCard.classList.remove('hidden');
                elems.suggestionContent.innerHTML = '';
                aiResult.suggestions.forEach(sug => {
                    elems.suggestionContent.innerHTML += `<p>${sug}</p>`;
                });

                // ä¿å­˜åˆ°å†å²è®°å½•
                saveHistory(need, aiResult.optimizedPrompt, aiResult.score, aiResult.suggestions);

                // æ»šåŠ¨åˆ°ç»“æœåŒº
                elems.resultArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (err) {
                hideLoading();
                elems.generateBtn.disabled = false;
                elems.generateBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                alert(`AIæ¨¡å‹è¿è½¬å¤±è´¥ï¼š${err.message}`);
            }
        });

        // ========== 9. å¤åˆ¶åŠŸèƒ½ ==========
        elems.copyBtn.addEventListener('click', async () => {
            const text = elems.resultArea.value.trim();
            if (!text) {
                alert('æš‚æ— AIä¼˜åŒ–åçš„æç¤ºè¯ï¼Œæ— æ³•å¤åˆ¶ï¼');
                return;
            }
            try {
                await navigator.clipboard.writeText(text);
                elems.copyTip.classList.remove('hidden');
                setTimeout(() => elems.copyTip.classList.add('hidden'), 2000);
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼');
            }
        });

        // ========== 10. æ¸…ç©ºåŠŸèƒ½ ==========
        elems.clearBtn.addEventListener('click', () => {
            elems.userNeed.value = '';
            elems.resultArea.value = '';
            elems.originalPrompt.textContent = '';
            elems.resultScore.classList.add('hidden');
            elems.suggestionCard.classList.add('hidden');
            elems.copyTip.classList.add('hidden');
            elems.userNeed.focus();
        });

        // ========== 11. å†å²è®°å½•åŠŸèƒ½ï¼ˆå‡çº§ï¼šä¿å­˜è¯„åˆ†+å»ºè®®ï¼‰ ==========
        function saveHistory(need, optimizedPrompt, score, suggestions) {
            try {
                const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                const newRecord = {
                    id: Date.now(),
                    time: new Date().toLocaleString(),
                    need: need,
                    optimizedPrompt: optimizedPrompt,
                    score: score,
                    suggestions: suggestions
                };
                history.unshift(newRecord);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 10)));
                renderHistory();
            } catch (err) {
                console.error('ä¿å­˜å†å²å¤±è´¥ï¼š', err);
            }
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            elems.historyList.innerHTML = '';

            if (history.length === 0) {
                elems.historyList.appendChild(elems.emptyHistory);
                return;
            }

            elems.emptyHistory.remove();
            history.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'p-4 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 card-hover';
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-xs text-secondary dark:text-slate-400">${record.time}</span>
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${record.score >= 80 ? 'bg-success/10 text-success' : record.score >= 60 ? 'bg-warning/10 text-warning' : 'bg-danger/10 text-danger'}">
                            ${record.score}åˆ†
                        </span>
                    </div>
                    <div class="text-sm text-slate-700 dark:text-slate-300 mb-2 line-clamp-1">
                        <span class="font-medium">éœ€æ±‚ï¼š</span>${record.need}
                    </div>
                    <div class="text-xs text-slate-600 dark:text-slate-400 line-clamp-2 bg-white/50 dark:bg-slate-600/30 p-2 rounded mb-2">
                        <span class="font-medium">ä¼˜åŒ–åï¼š</span>${record.optimizedPrompt}
                    </div>
                    <div class="text-xs text-slate-500 dark:text-slate-500">
                        <span class="font-medium">å»ºè®®ï¼š</span>${record.suggestions[0] || 'æ— '}
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button class="history-copy text-xs px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20" data-id="${record.id}">
                            <i class="fas fa-copy mr-1"></i>å¤åˆ¶æç¤ºè¯
                        </button>
                        <button class="history-delete text-xs px-2 py-1 bg-danger/10 text-danger rounded hover:bg-danger/20" data-id="${record.id}">
                            <i class="fas fa-trash mr-1"></i>åˆ é™¤
                        </button>
                    </div>
                `;
                elems.historyList.appendChild(historyItem);
            });

            // ç»‘å®šå†å²è®°å½•äº‹ä»¶
            bindHistoryEvents();
        }

        function bindHistoryEvents() {
            // å¤åˆ¶å†å²æç¤ºè¯
            document.querySelectorAll('.history-copy').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = Number(e.target.closest('button').dataset.id);
                    const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                    const record = history.find(item => item.id === id);
                    if (record) {
                        await navigator.clipboard.writeText(record.optimizedPrompt);
                        elems.copyTip.classList.remove('hidden');
                        setTimeout(() => elems.copyTip.classList.add('hidden'), 2000);
                    }
                });
            });

            // åˆ é™¤å•æ¡å†å²
            document.querySelectorAll('.history-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡AIç”Ÿæˆè®°å½•å—ï¼Ÿ')) return;
                    const id = Number(e.target.closest('button').dataset.id);
                    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                    history = history.filter(item => item.id !== id);
                    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                    renderHistory();
                });
            });
        }

        // æ¸…ç©ºæ‰€æœ‰å†å²
        elems.clearHistory.addEventListener('click', () => {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰AIç”Ÿæˆå†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            localStorage.removeItem(HISTORY_KEY);
            renderHistory();
        });

        // ========== 12. å¿«æ·æ“ä½œï¼šCtrl+Enterç”Ÿæˆ ==========
        elems.userNeed.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                elems.generateBtn.click();
            }
        });
    </script>
</body>
</html>
