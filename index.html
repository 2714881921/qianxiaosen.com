<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒå°æ£® - AIæç¤ºè¯ç”Ÿæˆå™¨</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Tailwindé…ç½®ï¼šçº¯ç™½ä¸»è‰²è°ƒ + æ£®ç³»ç»¿è‰²è¾…åŠ© -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4d7c0f', // æ£®ç³»ç»¿ï¼ˆè´´åˆlogoï¼‰
                        secondary: '#f3f4f6',
                        success: '#16a34a',
                        danger: '#dc2626',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    keyframes: {
                        spin: {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        }
                    },
                    animation: {
                        spin: 'spin 1s linear infinite',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .input-focus { @apply focus:ring-2 focus:ring-primary/40 focus:border-primary focus:outline-none; }
            .btn-hover { @apply hover:shadow-md hover:-translate-y-0.5 transition-all duration-200; }
            .card-hover { @apply hover:shadow-sm hover:border-primary/20 transition-all duration-200; }
        }
        /* å…¨å±€çº¯ç™½é£æ ¼ */
        html { transition: background-color 0.3s ease, color 0.3s ease; }
        body { background-color: #ffffff !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-300 rounded-full; }
        ::-webkit-scrollbar-track { @apply bg-slate-100; }
        /* åŠ è½½å¼¹çª— */
        .loading-overlay {
            @apply fixed inset-0 bg-black/20 flex items-center justify-center z-50 backdrop-blur-sm hidden;
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">
    <!-- é¡¶éƒ¨å¯¼èˆªï¼ˆçº¯ç™½+å“ç‰Œlogoï¼‰ -->
    <header class="bg-white shadow-sm py-4 px-6 border-b border-slate-100">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <!-- åƒå°æ£®logo -->
                <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
                    <svg viewBox="0 0 100 100" class="w-8 h-8 text-primary" xmlns="http://www.w3.org/2000/svg">
                        <text x="50" y="60" text-anchor="middle" font-size="18" font-weight="bold">åƒå°æ£®</text>
                        <circle cx="50" cy="50" r="40" fill="none" stroke="#4d7c0f" stroke-width="2"/>
                        <path d="M30 40 L30 70 L25 70 L25 40 M35 40 L35 70 L40 70 L40 40 M60 40 L60 70 L55 70 L55 40 M65 40 L65 70 L70 70 L70 40" fill="#4d7c0f"/>
                        <path d="M20 60 L25 50 L30 60 Z M70 60 L75 50 L80 60 Z" fill="#4d7c0f"/>
                    </svg>
                </div>
                <h1 class="text-[clamp(1.5rem,4vw,2rem)] font-bold text-slate-900">
                    åƒå°æ£® Â· AIæç¤ºè¯ç”Ÿæˆå™¨
                </h1>
            </div>
            <!-- æç®€åŠŸèƒ½æŒ‰é’® -->
            <div class="flex items-center gap-3">
                <button id="theme-toggle" class="bg-secondary p-2 rounded-full btn-hover" title="åˆ‡æ¢æ¨¡å¼">
                    <i class="fas fa-sun text-amber-500"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºï¼ˆçº¯ç™½æç®€ï¼‰ -->
    <main class="flex-grow py-8 px-6">
        <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-sm border border-slate-100 p-6 md:p-8">
            <!-- 1. æç®€æ¨¡å‹é…ç½® -->
            <div class="mb-6 p-4 bg-secondary rounded-lg">
                <h3 class="text-slate-800 font-medium mb-3 flex items-center gap-2">
                    <i class="fas fa-cogs text-primary"></i> ç”Ÿæˆé…ç½®
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- AIæ¨¡å‹ç±»å‹ -->
                    <div>
                        <label class="block text-slate-700 text-sm font-medium mb-2">ç”Ÿæˆç±»å‹</label>
                        <select id="ai-model-type" class="w-full p-3 border border-slate-200 rounded-lg input-focus bg-white">
                            <option value="general">é€šç”¨æç¤ºè¯</option>
                            <option value="painting">ç»˜ç”»æç¤ºè¯ï¼ˆMJ/SDï¼‰</option>
                            <option value="writing">æ–‡æ¡ˆæç¤ºè¯ï¼ˆå°çº¢ä¹¦/å…¬ä¼—å·ï¼‰</option>
                            <option value="coding">ç¼–ç¨‹æç¤ºè¯</option>
                        </select>
                    </div>
                    <!-- é£æ ¼å‚æ•° -->
                    <div>
                        <label class="block text-slate-700 text-sm font-medium mb-2">é£æ ¼/å­—æ•°</label>
                        <div class="grid grid-cols-2 gap-2">
                            <select id="word-count" class="p-3 border border-slate-200 rounded-lg input-focus bg-white">
                                <option value="unlimited">ä¸é™å­—æ•°</option>
                                <option value="50">50å­—å†…</option>
                                <option value="100">100å­—å†…</option>
                            </select>
                            <input type="text" id="prompt-style" placeholder="ä¾‹ï¼šæ²»æ„ˆ/èµ›åšæœ‹å…‹" class="p-3 border border-slate-200 rounded-lg input-focus bg-white">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. è¾“å…¥åŒºåŸŸ -->
            <div class="mb-6">
                <label for="user-need" class="block text-slate-800 font-medium mb-2">
                    ä½ çš„éœ€æ±‚ <span class="text-danger">*</span>
                </label>
                <textarea 
                    id="user-need" 
                    class="w-full h-32 md:h-40 p-4 border border-slate-200 rounded-lg input-focus resize-y bg-white"
                    placeholder="ä¾‹ï¼šç”Ÿæˆä¸€å¼ æ£®ç³»æ²»æ„ˆçš„æ’ç”»ï¼Œæœ‰å°é¹¿ã€æºªæµã€é˜³å…‰ï¼›æˆ–å†™ä¸€ç¯‡æ˜¥æ—¥éœ²è¥çš„æœ‹å‹åœˆæ–‡æ¡ˆ..."
                ></textarea>
                <p class="text-xs text-slate-500 mt-2">ğŸ’¡ éœ€æ±‚è¶Šå…·ä½“ï¼Œç”Ÿæˆçš„æç¤ºè¯è¶Šç²¾å‡†</p>
            </div>

            <!-- 3. æ“ä½œæŒ‰é’®åŒº -->
            <div class="flex gap-4 mb-8 flex-wrap">
                <button id="generate-btn" class="bg-primary text-white px-6 py-3 rounded-lg font-medium btn-hover flex items-center gap-2">
                    <i class="fas fa-magic"></i> ä¸€é”®ç”Ÿæˆ
                </button>
                <button id="clear-btn" class="bg-secondary text-slate-700 px-6 py-3 rounded-lg font-medium btn-hover flex items-center gap-2">
                    <i class="fas fa-trash"></i> æ¸…ç©ºå†…å®¹
                </button>
            </div>

            <!-- 4. ç»“æœå±•ç¤ºåŒºï¼ˆç²¾ç®€ç‰ˆï¼‰ -->
            <div class="border-t border-slate-100 pt-8 mb-8">
                <div class="flex items-center mb-4">
                    <h3 class="text-slate-800 font-medium flex items-center gap-2 text-lg">
                        <i class="fas fa-check-circle text-success"></i> ç”Ÿæˆç»“æœ
                    </h3>
                </div>

                <!-- åŸå§‹éœ€æ±‚ -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-slate-600 mb-2">ä½ çš„éœ€æ±‚</h4>
                    <div id="original-prompt" class="p-3 bg-secondary rounded-lg text-sm text-slate-700"></div>
                </div>

                <!-- ä¼˜åŒ–åæç¤ºè¯ï¼ˆæ ¸å¿ƒï¼‰ -->
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-slate-600 mb-2">
                        AIä¼˜åŒ–æç¤ºè¯ <span class="text-xs text-primary">(åƒå°æ£®AIæ¨¡å‹ç”Ÿæˆ)</span>
                    </h4>
                    <div class="relative">
                        <textarea 
                            id="result-area" 
                            class="w-full h-40 md:h-48 p-4 border border-slate-200 rounded-lg bg-secondary readonly:cursor-default"
                            readonly
                            placeholder="ç‚¹å‡»ã€Œä¸€é”®ç”Ÿæˆã€ï¼ŒAIç«‹å³ç”Ÿæˆä¼˜åŒ–æç¤ºè¯..."
                        ></textarea>
                        <button 
                            id="copy-btn" 
                            class="absolute top-3 right-3 bg-primary/90 text-white p-2 rounded-lg btn-hover"
                            title="å¤åˆ¶æç¤ºè¯"
                        >
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- ä¼˜åŒ–å»ºè®®ï¼ˆç²¾ç®€ï¼‰ -->
                <div id="suggestion-card" class="p-4 border border-slate-200 rounded-lg bg-secondary hidden">
                    <h4 class="text-sm font-medium text-slate-600 mb-2 flex items-center gap-2">
                        <i class="fas fa-lightbulb text-primary"></i> ä¼˜åŒ–å»ºè®®
                    </h4>
                    <div id="suggestion-content" class="text-sm text-slate-700 space-y-2"></div>
                </div>

                <!-- å¤åˆ¶æç¤º -->
                <p id="copy-tip" class="text-success text-sm mt-3 hidden flex items-center gap-1">
                    <i class="fas fa-check"></i> å¤åˆ¶æˆåŠŸï¼
                </p>
            </div>

            <!-- 5. å†å²è®°å½•åŒºï¼ˆç²¾ç®€ï¼‰ -->
            <div class="border-t border-slate-100 pt-8">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-slate-800 font-medium flex items-center gap-2">
                        <i class="fas fa-history text-primary"></i> ç”Ÿæˆå†å²
                    </h3>
                    <button id="clear-history" class="text-sm text-slate-500 hover:text-danger btn-hover">
                        <i class="fas fa-trash-alt"></i> æ¸…ç©º
                    </button>
                </div>
                <div id="history-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                    <div id="empty-history" class="text-center py-8 text-slate-400">
                        <i class="fas fa-inbox text-2xl mb-2"></i>
                        <p>æš‚æ— ç”Ÿæˆè®°å½•ï¼Œç‚¹å‡»ã€Œä¸€é”®ç”Ÿæˆã€å¼€å§‹å§ï½</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨ï¼ˆçº¯ç™½æç®€ï¼‰ -->
    <footer class="bg-white py-4 px-6 text-center text-sm border-t border-slate-100">
        <p class="text-slate-600">åƒå°æ£® AIæç¤ºè¯ç”Ÿæˆå™¨ Â© 2026 | æç®€ Â· é«˜æ•ˆ Â· å…è´¹</p>
    </footer>

    <!-- åŠ è½½å¼¹çª—ï¼ˆæç®€ï¼‰ -->
    <div id="loading-modal" class="loading-overlay">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-md border border-slate-100">
            <div class="flex flex-col items-center justify-center gap-4">
                <div class="w-12 h-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin"></div>
                <h3 class="text-lg font-bold text-slate-900">åƒå°æ£®AIå¤„ç†ä¸­</h3>
                <p class="text-center text-slate-600 text-sm">
                    æ­£åœ¨ç”Ÿæˆç²¾å‡†æç¤ºè¯ï¼Œè¯·ç¨å€™...
                </p>
            </div>
        </div>
    </div>

    <!-- JavaScriptæ ¸å¿ƒé€»è¾‘ï¼ˆå†…ç½®API + ç²¾ç®€ï¼‰ -->
    <script>
        // ========== å…ƒç´ è·å– ==========
        const elems = {
            userNeed: document.getElementById('user-need'),
            generateBtn: document.getElementById('generate-btn'),
            clearBtn: document.getElementById('clear-btn'),
            resultArea: document.getElementById('result-area'),
            originalPrompt: document.getElementById('original-prompt'),
            copyBtn: document.getElementById('copy-btn'),
            copyTip: document.getElementById('copy-tip'),
            themeToggle: document.getElementById('theme-toggle'),
            aiModelType: document.getElementById('ai-model-type'),
            wordCount: document.getElementById('word-count'),
            promptStyle: document.getElementById('prompt-style'),
            suggestionCard: document.getElementById('suggestion-card'),
            suggestionContent: document.getElementById('suggestion-content'),
            loadingModal: document.getElementById('loading-modal'),
            historyList: document.getElementById('history-list'),
            emptyHistory: document.getElementById('empty-history'),
            clearHistory: document.getElementById('clear-history')
        };

        // å­˜å‚¨key
        const HISTORY_KEY = 'qiaoxiaosen_prompt_history';

        // ========== åˆå§‹åŒ– ==========
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            renderHistory();
            elems.userNeed.focus();
            elems.loadingModal.classList.add('hidden'); // åˆå§‹éšè—åŠ è½½
        });

        // ========== 1. æç®€æ·±è‰²æ¨¡å¼ï¼ˆå¼±åŒ–ï¼Œçº¯ç™½ä¸ºä¸»ï¼‰ ==========
        function initTheme() {
            document.documentElement.classList.add('light'); // å¼ºåˆ¶æµ…è‰²ï¼ˆçº¯ç™½ï¼‰
        }

        elems.themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            if (isDark) {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
                elems.themeToggle.innerHTML = '<i class="fas fa-sun text-amber-500"></i>';
            } else {
                document.documentElement.classList.add('dark');
                document.documentElement.classList.remove('light');
                elems.themeToggle.innerHTML = '<i class="fas fa-moon text-slate-700"></i>';
            }
        });

        // ========== 2. æ ¸å¿ƒï¼šå†…ç½®API + æœ¬åœ°åŒæ¨¡å¼ï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰ ==========
        /**
         * å†…ç½®AIæ¨¡å‹ï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œè‡ªåŠ¨åˆ‡æ¢ï¼‰
         * @param {string} need - ç”¨æˆ·éœ€æ±‚
         * @returns {Object} { optimizedPrompt, suggestions }
         */
        async function builtInAIModel(need) {
            const modelType = elems.aiModelType.value;
            const count = elems.wordCount.value;
            const style = elems.promptStyle.value;

            // æ˜¾ç¤ºåŠ è½½ï¼ˆä»…çŸ­æš‚æ˜¾ç¤ºï¼Œæå‡æ„ŸçŸ¥ï¼‰
            elems.loadingModal.classList.remove('hidden');

            try {
                // ========== å†…ç½®APIé€»è¾‘ï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œæ— éœ€å¡«å†™ï¼‰ ==========
                // è¿™é‡Œæ›¿æ¢ä¸ºä½ çš„çœŸå®APIï¼ˆå·²åšè„±æ•å¤„ç†ï¼Œç”¨æˆ·çœ‹ä¸åˆ°ï¼‰
                const API_CONFIG = {
                    url: 'https://api.qiaoxiaosen.com/v1/ai/prompt', // ç¤ºä¾‹å†…ç½®APIåœ°å€
                    key: 'built-in-api-key-2026' // å†…ç½®API Keyï¼ˆå‰ç«¯è„±æ•ï¼Œå®é™…éƒ¨ç½²å»ºè®®åç«¯ä»£ç†ï¼‰
                };

                // æ¨¡æ‹ŸAPIè°ƒç”¨ï¼ˆå®é™…é¡¹ç›®æ›¿æ¢ä¸ºçœŸå®è¯·æ±‚ï¼‰
                const mockApiCall = () => new Promise(resolve => {
                    setTimeout(() => {
                        // æœ¬åœ°æé€Ÿä¼˜åŒ–é€»è¾‘ï¼ˆAPIå…œåº•ï¼‰
                        const styleText = style.trim() ? `ï¼Œé£æ ¼ï¼š${style.trim()}` : '';
                        const countText = count !== 'unlimited' ? `ï¼Œå­—æ•°â‰¤${count}` : '';
                        
                        // æ¨¡å‹ä¸“å±æç¤ºè¯
                        let optimizedPrompt = '';
                        switch (modelType) {
                            case 'painting':
                                optimizedPrompt = `ã€åƒå°æ£®ç»˜ç”»æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼š8Kè¶…é«˜æ¸…ã€è‡ªç„¶å…‰å½±ã€æ£®ç³»æ²»æ„ˆæ°›å›´${styleText}${countText}ï¼Œé€‚é…Midjourney/Stable Diffusionç”Ÿæˆï¼Œç»†èŠ‚ä¸°å¯Œï¼Œç”»é¢å±‚æ¬¡åˆ†æ˜ã€‚`;
                                break;
                            case 'writing':
                                optimizedPrompt = `ã€åƒå°æ£®æ–‡æ¡ˆæç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼šè¯­æ°”äº²åˆ‡è‡ªç„¶ã€è´´åˆåœºæ™¯${styleText}${countText}ï¼Œé€‚é…å°çº¢ä¹¦/å…¬ä¼—å·ä¼ æ’­ï¼Œæœ‰æ„ŸæŸ“åŠ›å’Œè®°å¿†ç‚¹ã€‚`;
                                break;
                            case 'coding':
                                optimizedPrompt = `ã€åƒå°æ£®ç¼–ç¨‹æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼šä»£ç è§„èŒƒã€æ³¨é‡Šæ¸…æ™°${styleText}${countText}ï¼Œé€‚é…ä¸»æµç¼–ç¨‹è¯­è¨€ï¼Œå¯ç›´æ¥è¿è¡Œæ— æŠ¥é”™ã€‚`;
                                break;
                            default:
                                optimizedPrompt = `ã€åƒå°æ£®é€šç”¨æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚è¦æ±‚ï¼šç²¾å‡†åŒ¹é…éœ€æ±‚ã€é€»è¾‘æ¸…æ™°${styleText}${countText}ï¼Œé€‚é…é€šç”¨å¤§æ¨¡å‹ï¼Œè¾“å‡ºç»“æœç¬¦åˆé¢„æœŸã€‚`;
                        }

                        // æç®€å»ºè®®
                        const suggestions = [
                            'âœ… æç¤ºè¯å·²ä¼˜åŒ–ï¼Œå¯ç›´æ¥ä½¿ç”¨',
                            modelType === 'painting' ? 'ğŸ¨ è¡¥å……ã€Œè‰²å½©åå¥½ã€å¯æå‡ç”»é¢æ•ˆæœ' :
                            modelType === 'writing' ? 'âœï¸ æ˜ç¡®ã€Œç›®æ ‡äººç¾¤ã€å¯ä¼˜åŒ–æ–‡æ¡ˆè¯­æ°”' :
                            'ğŸ’¡ éœ€æ±‚è¶Šå…·ä½“ï¼Œç”Ÿæˆç»“æœè¶Šç²¾å‡†'
                        ];

                        resolve({ optimizedPrompt, suggestions });
                    }, 800); // çŸ­æš‚åŠ è½½ï¼Œæå‡ä½“éªŒ
                });

                // ä¼˜å…ˆè°ƒç”¨å†…ç½®APIï¼Œå¤±è´¥è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°
                const result = await mockApiCall();
                
                // éšè—åŠ è½½
                elems.loadingModal.classList.add('hidden');
                return result;
            } catch (err) {
                // APIå¤±è´¥è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°æ¨¡å‹
                elems.loadingModal.classList.add('hidden');
                console.log('å†…ç½®APIé™çº§åˆ°æœ¬åœ°æ¨¡å‹ï¼š', err.message);
                
                // æœ¬åœ°æé€Ÿä¼˜åŒ–
                const styleText = style.trim() ? `ï¼Œé£æ ¼ï¼š${style.trim()}` : '';
                const countText = count !== 'unlimited' ? `ï¼Œå­—æ•°â‰¤${count}` : '';
                
                let optimizedPrompt = '';
                switch (modelType) {
                    case 'painting':
                        optimizedPrompt = `ã€åƒå°æ£®ç»˜ç”»æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚8Kè¶…é«˜æ¸…ã€æ£®ç³»æ°›å›´${styleText}${countText}ã€‚`;
                        break;
                    case 'writing':
                        optimizedPrompt = `ã€åƒå°æ£®æ–‡æ¡ˆæç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚äº²åˆ‡è‡ªç„¶${styleText}${countText}ã€‚`;
                        break;
                    case 'coding':
                        optimizedPrompt = `ã€åƒå°æ£®ç¼–ç¨‹æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}ã€‚ä»£ç è§„èŒƒ${styleText}${countText}ã€‚`;
                        break;
                    default:
                        optimizedPrompt = `ã€åƒå°æ£®é€šç”¨æç¤ºè¯ã€‘éœ€æ±‚ï¼š${need}${styleText}${countText}ã€‚`;
                }

                const suggestions = [
                    'âœ… æç¤ºè¯ç”Ÿæˆå®Œæˆ',
                    'ğŸ’¡ è¡¥å……æ›´å¤šç»†èŠ‚å¯æå‡ç²¾å‡†åº¦'
                ];

                return { optimizedPrompt, suggestions };
            }
        }

        // ========== 3. ç”ŸæˆæŒ‰é’®æ ¸å¿ƒé€»è¾‘ ==========
        elems.generateBtn.addEventListener('click', async () => {
            const need = elems.userNeed.value.trim();
            if (!need) {
                alert('è¯·è¾“å…¥ä½ çš„éœ€æ±‚åå†ç”Ÿæˆï¼');
                elems.userNeed.focus();
                return;
            }

            // ç¦ç”¨æŒ‰é’®
            elems.generateBtn.disabled = true;
            elems.generateBtn.classList.add('opacity-70', 'cursor-not-allowed');

            try {
                // è°ƒç”¨å†…ç½®AIæ¨¡å‹
                const { optimizedPrompt, suggestions } = await builtInAIModel(need);

                // æ¸²æŸ“ç»“æœ
                elems.originalPrompt.textContent = need;
                elems.resultArea.value = optimizedPrompt;
                
                // æ˜¾ç¤ºå»ºè®®
                elems.suggestionCard.classList.remove('hidden');
                elems.suggestionContent.innerHTML = '';
                suggestions.forEach(sug => {
                    elems.suggestionContent.innerHTML += `<p>${sug}</p>`;
                });

                // ä¿å­˜å†å²
                saveHistory(need, optimizedPrompt, suggestions);

                // æ»šåŠ¨åˆ°ç»“æœåŒº
                elems.resultArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (err) {
                alert(`ç”Ÿæˆå¤±è´¥ï¼š${err.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®
                elems.generateBtn.disabled = false;
                elems.generateBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });

        // ========== 4. å¤åˆ¶åŠŸèƒ½ ==========
        elems.copyBtn.addEventListener('click', async () => {
            const text = elems.resultArea.value.trim();
            if (!text) {
                alert('æš‚æ— æç¤ºè¯å¯å¤åˆ¶ï¼');
                return;
            }
            try {
                await navigator.clipboard.writeText(text);
                elems.copyTip.classList.remove('hidden');
                setTimeout(() => elems.copyTip.classList.add('hidden'), 1500);
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼');
            }
        });

        // ========== 5. æ¸…ç©ºåŠŸèƒ½ ==========
        elems.clearBtn.addEventListener('click', () => {
            elems.userNeed.value = '';
            elems.resultArea.value = '';
            elems.originalPrompt.textContent = '';
            elems.suggestionCard.classList.add('hidden');
            elems.copyTip.classList.add('hidden');
            elems.userNeed.focus();
        });

        // ========== 6. å†å²è®°å½•ï¼ˆç²¾ç®€ï¼‰ ==========
        function saveHistory(need, optimizedPrompt, suggestions) {
            try {
                const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                const newRecord = {
                    id: Date.now(),
                    time: new Date().toLocaleString(),
                    need: need,
                    optimizedPrompt: optimizedPrompt,
                    suggestions: suggestions
                };
                history.unshift(newRecord);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 10)));
                renderHistory();
            } catch (err) {
                console.error('ä¿å­˜å†å²å¤±è´¥ï¼š', err);
            }
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            elems.historyList.innerHTML = '';

            if (history.length === 0) {
                elems.historyList.appendChild(elems.emptyHistory);
                return;
            }

            elems.emptyHistory.remove();
            history.forEach(record => {
                const historyItem = document.createElement('div');
                historyItem.className = 'p-4 border border-slate-200 rounded-lg bg-white card-hover';
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs text-slate-500">${record.time}</span>
                    </div>
                    <div class="text-sm text-slate-800 mb-2 line-clamp-1">éœ€æ±‚ï¼š${record.need}</div>
                    <div class="text-xs text-slate-600 line-clamp-2 bg-secondary p-2 rounded mb-2">
                        æç¤ºè¯ï¼š${record.optimizedPrompt}
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button class="history-copy text-xs px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20" data-id="${record.id}">
                            <i class="fas fa-copy mr-1"></i>å¤åˆ¶
                        </button>
                        <button class="history-delete text-xs px-2 py-1 bg-danger/10 text-danger rounded hover:bg-danger/20" data-id="${record.id}">
                            <i class="fas fa-trash mr-1"></i>åˆ é™¤
                        </button>
                    </div>
                `;
                elems.historyList.appendChild(historyItem);
            });
            bindHistoryEvents();
        }

        function bindHistoryEvents() {
            // å¤åˆ¶å†å²
            document.querySelectorAll('.history-copy').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = Number(e.target.closest('button').dataset.id);
                    const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                    const record = history.find(item => item.id === id);
                    if (record) {
                        await navigator.clipboard.writeText(record.optimizedPrompt);
                        elems.copyTip.classList.remove('hidden');
                        setTimeout(() => elems.copyTip.classList.add('hidden'), 1500);
                    }
                });
            });
            // åˆ é™¤å†å²
            document.querySelectorAll('.history-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
                    const id = Number(e.target.closest('button').dataset.id);
                    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                    history = history.filter(item => item.id !== id);
                    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                    renderHistory();
                });
            });
        }

        // æ¸…ç©ºå†å²
        elems.clearHistory.addEventListener('click', () => {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²å—ï¼Ÿ')) return;
            localStorage.removeItem(HISTORY_KEY);
            renderHistory();
        });

        // ========== 7. å¿«æ·ç”Ÿæˆï¼šCtrl+Enter ==========
        elems.userNeed.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                elems.generateBtn.click();
            }
        });
    </script>
</body>
</html>
